# 补丁撤销/补丁合并改造计划

目标：让补丁撤销与补丁合并在“只有移动/修改”时也能正确还原，并且保留歧义层（预览里用户选择），同时匹配规则遵循“URL 优先、标题次之、路径仅提示”的原则。

## 范围
- 备份历史补丁恢复（history 页面）
- 设置与初始化的补丁恢复（popup 主 UI）
- 当前变化的补丁撤销（history 页面）

## 基础流程（对齐你确认过的逻辑）
1. **ID 对齐**：当前树 vs 目标快照，ID 相同直接认定为同一节点。
2. **移动/修改**：同 ID 的节点，按目标快照还原位置（move）与内容（update）。
3. **新增/删除**：ID 对不上的部分进入“新增/删除候选”。
4. **歧义层（预览）**：对新增/删除候选做配对提示，书签用 URL+标题匹配，文件夹仅名称匹配；路径只作提示，不作硬规则；用户确认的候选转成移动/修改。
5. **执行顺序**：新增（父先子后）→ 移动 → 修改 → 删除（仅顶层删除）。

## 具体改动清单
- background.js：恢复补丁执行中的 move/update，保持 add/delete；统计 moved/updated；补丁后校验。
- history_html/history.js：补丁恢复与补丁撤销恢复 move/update；预览/差异统计恢复 moved/modified 显示；移除“仅新增/删除”的提示。
- popup.js：补丁预演与预览恢复 moved/modified 显示；补丁完成提示恢复 moved/updated；文案恢复为“新增/移动/修改/删除”。
- normalizeTreeIds（背景预演/歧义）：保留 URL 优先、标题次之；文件夹仅名称匹配；路径仅提示；歧义列表继续由用户确认。

## 验证点
- 只有移动/修改时：预览有变化提示，补丁可执行且结果正确。
- 只有新增/删除时：行为与之前一致。
- 混合场景：移动/修改 + 新增/删除都能正确还原。

