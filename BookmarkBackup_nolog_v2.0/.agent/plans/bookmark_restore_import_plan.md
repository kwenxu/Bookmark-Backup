# ä¹¦ç­¾æ¢å¤ä¸å¯¼å…¥åŠŸèƒ½è®¡åˆ’ä¹¦

> åˆ›å»ºæ—¶é—´ï¼š2026-01-09  
> çŠ¶æ€ï¼šğŸ“‹ è§„åˆ’ä¸­

---

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

### é¡¹ç›®åç§°
ä¹¦ç­¾æ¢å¤ä¸å¯¼å…¥åŠŸèƒ½ï¼ˆBookmark Restore & Importï¼‰

### æ ¸å¿ƒç†å¿µ
ç±»ä¼¼ Git çš„ç‰ˆæœ¬ç®¡ç†ï¼š
- æ¯æ¡å¤‡ä»½å†å²è®°å½•éƒ½æ˜¯ä¸€ä¸ª**ç‰ˆæœ¬å¿«ç…§**
- å¯ä»¥**æ¢å¤**åˆ°ä»»æ„å†å²ç‰ˆæœ¬çš„ä¹¦ç­¾çŠ¶æ€
- å¯ä»¥**å¯¼å…¥**å¤–éƒ¨å¤‡ä»½å†å²æ–‡ä»¶
- å¯ä»¥ä»**äº‘ç«¯**æ¢å¤å®Œæ•´æ•°æ®

---

## ğŸ¯ ä¸‰é˜¶æ®µå®æ–½è®¡åˆ’

### ğŸ”· Phase 1: ä¹¦ç­¾ç‰ˆæœ¬æ¢å¤ï¼ˆä»æœ¬åœ° syncHistoryï¼‰â­ å½“å‰é‡ç‚¹

**åŠŸèƒ½å®šä½**ï¼šä»æœ¬åœ°å·²æœ‰çš„å¤‡ä»½å†å²ä¸­æ¢å¤ä¹¦ç­¾ï¼Œç±»ä¼¼ `git checkout`

**å…¥å£ä½ç½®**ï¼šhistory.html å¤‡ä»½å†å²è§†å›¾ â†’ æ¯æ¡è®°å½•å³ä¾§æ·»åŠ ã€Œæ¢å¤ã€æŒ‰é’®

```
å¤‡ä»½å†å²åˆ—è¡¨:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  #42  2026-01-09 15:30  [abc12345]  +5 -2 ~1                        â”‚
â”‚       ã€Œæ—¥å¸¸å¤‡ä»½ã€                           [è¯¦ç»†] [å¯¼å‡º] [æ¢å¤âœ¨]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  #41  2026-01-09 10:00  [def67890]  +2 -0 ~0                        â”‚
â”‚                                              [è¯¦ç»†] [å¯¼å‡º] [æ¢å¤]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°å†…å®¹**ï¼š

| åŠŸèƒ½ | æè¿° | ä¼˜å…ˆçº§ |
|------|------|--------|
| æ¢å¤æŒ‰é’® | æ¯æ¡è®°å½•æ·»åŠ æ¢å¤æŒ‰é’® | ğŸ”´ é«˜ |
| æ¢å¤ç¡®è®¤å¼¹çª— | æ˜¾ç¤ºæ¢å¤é¢„è§ˆå’Œè­¦å‘Š | ğŸ”´ é«˜ |
| æ¢å¤ç­–ç•¥ | è¦†ç›–/åˆå¹¶ä¸¤ç§æ¨¡å¼ | ğŸ”´ é«˜ |
| ä¹¦ç­¾æ¢å¤ | è°ƒç”¨ chrome.bookmarks API | ğŸ”´ é«˜ |
| æ¢å¤è¿›åº¦ | æ˜¾ç¤ºæ¢å¤è¿›åº¦ | ğŸŸ¡ ä¸­ |

**æ•°æ®æ¥æº**ï¼š`syncHistory[i].bookmarkTree`ï¼ˆæœ¬åœ°å·²å­˜å‚¨çš„å®Œæ•´ä¹¦ç­¾æ ‘ï¼‰

---

### ğŸ”· Phase 2: å¤‡ä»½å†å²å¯¼å…¥ï¼ˆä»å¤–éƒ¨æ–‡ä»¶ï¼‰

**åŠŸèƒ½å®šä½**ï¼šä»å¤–éƒ¨ JSON/ZIP æ–‡ä»¶å¯¼å…¥å¤‡ä»½å†å²åˆ° `syncHistory`

**å…¥å£ä½ç½®**ï¼šhistory.html å¤‡ä»½å†å²è§†å›¾ â†’ å…¨å±€å¯¼å‡ºæ—çš„ã€Œå¯¼å…¥ã€æŒ‰é’® âœ… å·²æ·»åŠ 

**å®ç°å†…å®¹**ï¼š

| åŠŸèƒ½ | æè¿° | ä¼˜å…ˆçº§ |
|------|------|--------|
| è§£æ JSON/ZIP | è§£æå¯¼å…¥çš„æ–‡ä»¶ | ğŸ”´ é«˜ |
| æ™ºèƒ½æ£€æµ‹ | æ£€æµ‹å½“å‰ä¹¦ç­¾ä¸å¯¼å…¥å†å²çš„åŒ¹é…åº¦ | ğŸ”´ é«˜ |
| è­¦å‘Šæç¤º | åŒ¹é…åº¦ä½æ—¶è­¦å‘Šï¼Œå»ºè®®å…ˆæ¢å¤ä¹¦ç­¾ | ğŸ”´ é«˜ |
| åˆå¹¶/è¦†ç›– | ç”¨æˆ·é€‰æ‹©å¯¼å…¥ç­–ç•¥ | ğŸŸ¡ ä¸­ |
| æ¢å¤è§†å›¾è®¾ç½® | æ¢å¤å±•å¼€çŠ¶æ€ç­‰ | ğŸŸ¡ ä¸­ |

**å…³è”**ï¼šå¯¼å…¥å†å²åï¼Œå¯ä»¥ä½¿ç”¨ Phase 1 çš„åŠŸèƒ½ä»å¯¼å…¥çš„è®°å½•æ¢å¤ä¹¦ç­¾

---

### ğŸ”· Phase 3: å®Œæ•´æ¢å¤å‘å¯¼ï¼ˆäº‘ç«¯/æœ¬åœ°ï¼‰

**åŠŸèƒ½å®šä½**ï¼šåœ¨è®¾ç½®ä¸åˆå§‹åŒ–é¢æ¿æä¾›ä¸€ç«™å¼æ¢å¤å…¥å£

**å…¥å£ä½ç½®**ï¼špopup.html è®¾ç½®ä¸åˆå§‹åŒ–é¢æ¿ â†’ å³ä¾§åŒºåŸŸ

**å®ç°å†…å®¹**ï¼š

| åŠŸèƒ½ | æè¿° | ä¼˜å…ˆçº§ |
|------|------|--------|
| äº‘ç«¯æ£€æµ‹ | æ£€æµ‹ WebDAV/GitHub æ˜¯å¦æœ‰å¤‡ä»½ | ğŸŸ¡ ä¸­ |
| æ•°æ®æºé€‰æ‹© | äº‘ç«¯/æœ¬åœ°æ–‡ä»¶é€‰æ‹© | ğŸŸ¡ ä¸­ |
| å¼•å¯¼å¼æ¢å¤ | æ­¥éª¤åŒ–æµç¨‹ï¼ˆä¹¦ç­¾â†’å†å²â†’è®¾ç½®ï¼‰ | ğŸŸ¡ ä¸­ |

---

## ğŸ—ï¸ Phase 1 è¯¦ç»†è®¾è®¡ï¼šä¹¦ç­¾ç‰ˆæœ¬æ¢å¤

### 1.1 UI è®¾è®¡

#### æ¢å¤æŒ‰é’®ä½ç½®

åœ¨æ¯æ¡å¤‡ä»½å†å²è®°å½•çš„æ“ä½œåŒºåŸŸæ·»åŠ ã€Œæ¢å¤ã€æŒ‰é’®ï¼š

```html
<div class="record-actions">
    <button class="action-btn" title="è¯¦ç»†">...</button>
    <button class="action-btn" title="å¯¼å‡º">...</button>
    <button class="restore-btn" title="æ¢å¤ä¹¦ç­¾">
        <i class="fas fa-undo"></i>
    </button>
</div>
```

#### æ¢å¤ç¡®è®¤å¼¹çª—

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”„ æ¢å¤ä¹¦ç­¾                                               [Ã—]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  å³å°†æ¢å¤åˆ°ä»¥ä¸‹ç‰ˆæœ¬:                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ğŸ“… 2026-01-09 15:30                                    â”‚    â”‚
â”‚  â”‚  ğŸ·ï¸ å¤‡æ³¨: æ—¥å¸¸å¤‡ä»½                                      â”‚    â”‚
â”‚  â”‚  ğŸ”¢ åºå·: #42                                           â”‚    â”‚
â”‚  â”‚  ğŸ“Š ä¹¦ç­¾: 143 ä¸ª  |  æ–‡ä»¶å¤¹: 30 ä¸ª                       â”‚    â”‚
â”‚  â”‚  ğŸ”‘ æŒ‡çº¹: abc12345                                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                 â”‚
â”‚  æ¢å¤ç­–ç•¥:                                                      â”‚
â”‚  â— è¦†ç›– - æ¸…ç©ºå½“å‰ä¹¦ç­¾ï¼Œä½¿ç”¨æ­¤ç‰ˆæœ¬æ›¿æ¢                           â”‚
â”‚  â—‹ åˆå¹¶ - ä¿ç•™å½“å‰ä¹¦ç­¾ï¼Œæ·»åŠ æ­¤ç‰ˆæœ¬ä¸­ç¼ºå¤±çš„                       â”‚
â”‚                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  âš ï¸ è­¦å‘Š                                                        â”‚
â”‚  æ­¤æ“ä½œå°†ä¿®æ”¹æ‚¨çš„æµè§ˆå™¨ä¹¦ç­¾ï¼Œå»ºè®®å…ˆå¯¼å‡ºå½“å‰ä¹¦ç­¾ä½œä¸ºå¤‡ä»½ã€‚          â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      [å–æ¶ˆ]         [ç¡®è®¤æ¢å¤]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ¢å¤æœŸé—´çš„å¤‡ä»½ç³»ç»Ÿè¡Œä¸º â­ æ ¸å¿ƒè®¾è®¡

#### æ¢å¤æµç¨‹è®¾è®¡

```
æ¢å¤å¼€å§‹
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. è®¾ç½®æ¢å¤æ ‡å¿—: isBookmarkRestoring = true                     â”‚
â”‚     (æš‚åœä¹¦ç­¾å˜åŒ–ç›‘å¬ï¼Œé¿å…äº§ç”Ÿä¸­é—´çŠ¶æ€å¤‡ä»½)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. æ‰§è¡Œæ¢å¤æ“ä½œ                                                 â”‚
â”‚     - æ¸…ç©ºå½“å‰ä¹¦ç­¾ï¼ˆè¦†ç›–æ¨¡å¼ï¼‰                                    â”‚
â”‚     - ä» record.bookmarkTree é‡å»ºä¹¦ç­¾ç»“æ„                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. æ¢å¤å®Œæˆåï¼Œé‡ç½®æ ‡å¿—: isBookmarkRestoring = false             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. è§¦å‘ä¸€æ¬¡å®Œæ•´å¤‡ä»½ï¼ˆä½œä¸ºæ¢å¤è®°å½•ï¼‰                              â”‚
â”‚     - type: 'restore'                                           â”‚
â”‚     - note: 'æ¢å¤è‡³ #42 (2026-01-09 15:30)'                     â”‚
â”‚     - åºå·ç»§ç»­é€’å¢ï¼ˆå¦‚ #43ï¼‰                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. æ›´æ–° UIï¼šçŠ¶æ€å¡ç‰‡ã€è§’æ ‡                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ¢å¤è®°å½•ç»“æ„

æ¢å¤å®Œæˆåç”Ÿæˆçš„å¤‡ä»½è®°å½•ï¼š

```javascript
{
    seqNumber: 43,                              // åºå·ç»§ç»­é€’å¢
    time: "2026-01-09T21:50:00.000Z",          // æ¢å¤æ—¶é—´
    type: "restore",                            // â­ ç±»å‹æ ‡è®°ä¸ºæ¢å¤
    status: "success",
    note: "æ¢å¤è‡³ #42 (2026-01-09 15:30)",     // â­ è‡ªåŠ¨å¤‡æ³¨
    fingerprint: "abc12345",                    // æ¢å¤åçš„æŒ‡çº¹
    direction: "local",                         // æ–¹å‘
    restoreInfo: {                              // â­ æ¢å¤å…ƒæ•°æ®
        sourceSeqNumber: 42,                    // æºç‰ˆæœ¬åºå·
        sourceTime: "2026-01-09T15:30:00.000Z", // æºç‰ˆæœ¬æ—¶é—´
        strategy: "overwrite"                   // æ¢å¤ç­–ç•¥
    },
    bookmarkStats: { ... },
    bookmarkTree: [ ... ]                       // æ¢å¤åçš„å®Œæ•´ä¹¦ç­¾æ ‘
}
```

#### ç°æœ‰ç›‘å¬æœºåˆ¶å¤ç”¨

å¤ç”¨å·²æœ‰çš„ `isBookmarkImporting` æ¨¡å¼ï¼Œæ·»åŠ  `isBookmarkRestoring` æ ‡å¿—ï¼š

```javascript
// background.js ä¸­æ·»åŠ 
let isBookmarkRestoring = false;  // æ¢å¤æœŸé—´æš‚åœç›‘å¬

// åœ¨ handleBookmarkChange() ä¸­æ£€æŸ¥
async function handleBookmarkChange() {
    // æ¢å¤æœŸé—´æˆ–å¯¼å…¥æœŸé—´ï¼šè·³è¿‡å¤„ç†
    if (isBookmarkRestoring || isBookmarkImporting) {
        return;
    }
    // ... åŸæœ‰é€»è¾‘
}
```

### 1.3 æ¢å¤ç­–ç•¥

| ç­–ç•¥ | æè¿° | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| **è¦†ç›–** | åˆ é™¤æ‰€æœ‰ç°æœ‰ä¹¦ç­¾ï¼Œä½¿ç”¨å¤‡ä»½ç‰ˆæœ¬æ›¿æ¢ | å®Œå…¨å›æ»šåˆ°å†å²ç‰ˆæœ¬ |
| **åˆå¹¶** | ä¿ç•™ç°æœ‰ä¹¦ç­¾ï¼Œæ·»åŠ å¤‡ä»½ä¸­å­˜åœ¨ä½†å½“å‰ç¼ºå¤±çš„ | æ‰¾å›è¯¯åˆ çš„ä¹¦ç­¾ |

### 1.4 æ ¸å¿ƒå‡½æ•°è®¾è®¡

#### `restoreBookmarksFromRecord(record, options)`

```javascript
/**
 * ä»å¤‡ä»½è®°å½•æ¢å¤ä¹¦ç­¾
 * @param {Object} record - syncHistory ä¸­çš„ä¸€æ¡è®°å½•
 * @param {Object} options - æ¢å¤é€‰é¡¹
 * @param {string} options.strategy - 'overwrite' | 'merge'
 * @param {boolean} options.backupFirst - æ¢å¤å‰æ˜¯å¦å…ˆå¤‡ä»½å½“å‰ä¹¦ç­¾
 * @returns {Promise<RestoreResult>}
 */
async function restoreBookmarksFromRecord(record, options) {
    const { strategy = 'overwrite', backupFirst = true } = options;
    
    // 1. æ¢å¤å‰å¤‡ä»½ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    if (backupFirst) {
        await createBackupBeforeRestore();
    }
    
    // 2. è·å–è¦æ¢å¤çš„ä¹¦ç­¾æ ‘
    const bookmarkTree = record.bookmarkTree;
    if (!bookmarkTree) {
        throw new Error('æ­¤è®°å½•ä¸åŒ…å«å®Œæ•´çš„ä¹¦ç­¾æ ‘æ•°æ®');
    }
    
    // 3. æ ¹æ®ç­–ç•¥æ‰§è¡Œæ¢å¤
    if (strategy === 'overwrite') {
        return await overwriteBookmarks(bookmarkTree);
    } else {
        return await mergeBookmarks(bookmarkTree);
    }
}
```

#### `overwriteBookmarks(bookmarkTree)`

```javascript
/**
 * è¦†ç›–æ¨¡å¼ï¼šæ¸…ç©ºç°æœ‰ä¹¦ç­¾ï¼Œä½¿ç”¨å¤‡ä»½æ›¿æ¢
 * @param {Object} bookmarkTree - ä¹¦ç­¾æ ‘æ•°æ®
 * @returns {Promise<{success: boolean, created: number, deleted: number}>}
 */
async function overwriteBookmarks(bookmarkTree) {
    // 1. è·å–æ ¹èŠ‚ç‚¹
    const [root] = await chrome.bookmarks.getTree();
    const bookmarkBar = root.children.find(c => c.id === '1');
    const otherBookmarks = root.children.find(c => c.id === '2');
    
    // 2. æ¸…ç©ºä¹¦ç­¾æ å’Œå…¶ä»–ä¹¦ç­¾ä¸‹çš„æ‰€æœ‰å†…å®¹
    let deletedCount = 0;
    for (const container of [bookmarkBar, otherBookmarks]) {
        if (container && container.children) {
            for (const child of [...container.children]) {
                await chrome.bookmarks.removeTree(child.id);
                deletedCount++;
            }
        }
    }
    
    // 3. ä»å¤‡ä»½æ ‘é‡å»ºä¹¦ç­¾
    let createdCount = 0;
    const nodes = Array.isArray(bookmarkTree) ? bookmarkTree : [bookmarkTree];
    
    for (const node of nodes) {
        if (node.children) {
            for (const topFolder of node.children) {
                // ç¡®å®šç›®æ ‡å®¹å™¨ï¼ˆä¹¦ç­¾æ æˆ–å…¶ä»–ä¹¦ç­¾ï¼‰
                const targetId = isBookmarkBar(topFolder) ? bookmarkBar.id : otherBookmarks.id;
                
                for (const child of topFolder.children || []) {
                    createdCount += await createNodeRecursive(child, targetId);
                }
            }
        }
    }
    
    return { success: true, created: createdCount, deleted: deletedCount };
}

/**
 * é€’å½’åˆ›å»ºä¹¦ç­¾/æ–‡ä»¶å¤¹
 */
async function createNodeRecursive(node, parentId) {
    let count = 0;
    
    if (node.url) {
        // åˆ›å»ºä¹¦ç­¾
        await chrome.bookmarks.create({
            parentId,
            title: node.title || '',
            url: node.url
        });
        count = 1;
    } else if (node.children !== undefined) {
        // åˆ›å»ºæ–‡ä»¶å¤¹
        const folder = await chrome.bookmarks.create({
            parentId,
            title: node.title || ''
        });
        count = 1;
        
        // é€’å½’åˆ›å»ºå­èŠ‚ç‚¹
        for (const child of node.children || []) {
            count += await createNodeRecursive(child, folder.id);
        }
    }
    
    return count;
}
```

#### `mergeBookmarks(bookmarkTree)`

```javascript
/**
 * åˆå¹¶æ¨¡å¼ï¼šä¿ç•™ç°æœ‰ï¼Œæ·»åŠ ç¼ºå¤±çš„
 * @param {Object} bookmarkTree - ä¹¦ç­¾æ ‘æ•°æ®
 * @returns {Promise<{success: boolean, added: number, skipped: number}>}
 */
async function mergeBookmarks(bookmarkTree) {
    // 1. è·å–å½“å‰ä¹¦ç­¾çš„ URL é›†åˆ
    const [root] = await chrome.bookmarks.getTree();
    const existingUrls = new Set();
    
    function collectUrls(node) {
        if (node.url) existingUrls.add(node.url);
        if (node.children) node.children.forEach(collectUrls);
    }
    root.children.forEach(collectUrls);
    
    // 2. éå†å¤‡ä»½æ ‘ï¼Œæ·»åŠ ä¸å­˜åœ¨çš„ä¹¦ç­¾
    let addedCount = 0;
    let skippedCount = 0;
    
    // è·å–"å…¶ä»–ä¹¦ç­¾"ä½œä¸ºé»˜è®¤æ·»åŠ ä½ç½®
    const otherBookmarks = root.children.find(c => c.id === '2');
    
    function addMissingBookmarks(node, parentId) {
        if (node.url) {
            if (!existingUrls.has(node.url)) {
                chrome.bookmarks.create({
                    parentId,
                    title: node.title || '',
                    url: node.url
                });
                addedCount++;
            } else {
                skippedCount++;
            }
        }
        if (node.children) {
            node.children.forEach(child => addMissingBookmarks(child, parentId));
        }
    }
    
    const nodes = Array.isArray(bookmarkTree) ? bookmarkTree : [bookmarkTree];
    nodes.forEach(node => {
        if (node.children) {
            node.children.forEach(topFolder => {
                if (topFolder.children) {
                    topFolder.children.forEach(child => {
                        addMissingBookmarks(child, otherBookmarks.id);
                    });
                }
            });
        }
    });
    
    return { success: true, added: addedCount, skipped: skippedCount };
}
```

### 1.5 æ¢å¤å‰å¤‡ä»½

```javascript
/**
 * æ¢å¤å‰åˆ›å»ºå½“å‰ä¹¦ç­¾çš„å¤‡ä»½
 */
async function createBackupBeforeRestore() {
    // è§¦å‘ä¸€æ¬¡æ‰‹åŠ¨å¤‡ä»½
    await chrome.runtime.sendMessage({
        action: 'triggerManualBackup',
        source: 'restore',
        note: 'æ¢å¤å‰è‡ªåŠ¨å¤‡ä»½'
    });
}
```

### 1.6 è¿›åº¦æ˜¾ç¤º

```javascript
/**
 * æ¢å¤è¿›åº¦å›è°ƒ
 * @param {Object} progress - { stage, current, total, message }
 */
function onRestoreProgress(progress) {
    const progressBar = document.getElementById('restoreProgressBar');
    const progressText = document.getElementById('restoreProgressText');
    
    const percent = Math.round((progress.current / progress.total) * 100);
    progressBar.style.width = `${percent}%`;
    progressText.textContent = progress.message;
}
```

---

## âœ… Phase 1 å®ç°æ¸…å•

### HTML ä¿®æ”¹
- [x] history.html: æ¯æ¡è®°å½•æ·»åŠ æ¢å¤æŒ‰é’® âœ… (å·²æœ‰)
- [x] history.html: æ·»åŠ æ¢å¤ç¡®è®¤å¼¹çª— âœ… (2026-01-09)

### CSS ä¿®æ”¹
- [x] history.css: æ¢å¤æŒ‰é’®æ ·å¼ âœ… (å·²æœ‰)
- [x] history.css: æ¢å¤ç¡®è®¤å¼¹çª—æ ·å¼ âœ… (å¤ç”¨ç°æœ‰æ ·å¼)

### JavaScript å®ç°
- [x] å®ç° `showRestoreModal()` ä¸»å‡½æ•° âœ… (2026-01-09)
- [x] å®ç° `executeOverwriteRestore()` è¦†ç›–æ¨¡å¼ âœ… (2026-01-09)
- [x] å®ç° `executeMergeRestore()` åˆå¹¶æ¨¡å¼ âœ… (2026-01-09)
- [x] å®ç° `createNodeRecursive()` é€’å½’åˆ›å»º âœ… (2026-01-09)
- [x] æ¢å¤æœŸé—´æš‚åœç›‘å¬ (`isBookmarkRestoring`) âœ… (2026-01-09)
- [x] æ¢å¤åè§¦å‘å¤‡ä»½è®°å½• (`triggerRestoreBackup`) âœ… (2026-01-09)
- [x] æ·»åŠ æ¢å¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶ âœ… (å·²æœ‰)
- [x] å®ç°æ¢å¤ç¡®è®¤å¼¹çª—é€»è¾‘ âœ… (2026-01-09)
- [x] å®ç°è¿›åº¦æ˜¾ç¤º âœ… (2026-01-09)
- [x] æ·»åŠ å¤šè¯­è¨€æ”¯æŒ âœ… (2026-01-09)

### æµ‹è¯•
- [ ] æµ‹è¯•è¦†ç›–æ¨¡å¼æ¢å¤
- [ ] æµ‹è¯•åˆå¹¶æ¨¡å¼æ¢å¤
- [ ] æµ‹è¯•æ¢å¤åçš„å¤‡ä»½è®°å½•
- [ ] æµ‹è¯•å¤§é‡ä¹¦ç­¾æ¢å¤æ€§èƒ½

---

## ğŸ“Š æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æ¢å¤ä¸å¯¼å…¥åŠŸèƒ½                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ Phase 1: ç‰ˆæœ¬æ¢å¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚   æœ¬åœ°æ•°æ® (syncHistory)                                                â”‚
â”‚        â†“                                                               â”‚
â”‚   [æ¢å¤æŒ‰é’®] â†’ é€‰æ‹©ç‰ˆæœ¬ â†’ ç¡®è®¤å¼¹çª— â†’ æ¢å¤ä¹¦ç­¾                            â”‚
â”‚        â”‚                                                               â”‚
â”‚        â””â”€ æ•°æ®æ¥æº: record.bookmarkTree                                 â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“
â”Œâ”€ Phase 2: å†å²å¯¼å…¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚   å¤–éƒ¨æ–‡ä»¶ (JSON/ZIP)                                                   â”‚
â”‚        â†“                                                               â”‚
â”‚   [å¯¼å…¥æŒ‰é’®] â†’ è§£ææ–‡ä»¶ â†’ æ™ºèƒ½æ£€æµ‹ â†’ å¯¼å…¥åˆ° syncHistory                  â”‚
â”‚        â”‚                         â”‚                                     â”‚
â”‚        â”‚                         â””â”€ åŒ¹é…åº¦ä½ â†’ å»ºè®®å…ˆæ¢å¤ä¹¦ç­¾            â”‚
â”‚        â”‚                                       (ä½¿ç”¨ Phase 1)           â”‚
â”‚        â””â”€ å¯¼å…¥åå¯ä½¿ç”¨ Phase 1 æ¢å¤                                      â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“
â”Œâ”€ Phase 3: å®Œæ•´æ¢å¤å‘å¯¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚   äº‘ç«¯/æœ¬åœ° (WebDAV/GitHub/æ–‡ä»¶)                                        â”‚
â”‚        â†“                                                               â”‚
â”‚   [æ¢å¤å‘å¯¼] â†’ é€‰æ‹©æ•°æ®æº â†’ é€‰æ‹©å†…å®¹ â†’ æ‰§è¡Œæ¢å¤                          â”‚
â”‚                                                                         â”‚
â”‚   å…¥å£: è®¾ç½®ä¸åˆå§‹åŒ–é¢æ¿å³ä¾§                                             â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ å…³è”æ–‡æ¡£

- [å¤‡ä»½å†å²ç»Ÿä¸€å­˜å‚¨è®¡åˆ’ä¹¦](./backup_history_unified_storage_plan.md)
- [å¤‡ä»½å†å²å¯¼å…¥æ¢å¤è®¡åˆ’ä¹¦](./backup_history_import_restore_plan.md)
- [å®Œæ•´æ¢å¤å‘å¯¼è®¡åˆ’ä¹¦](./complete_restore_wizard_plan.md)
- [è®¾ç½®ä¸åˆå§‹åŒ– UI è®¡åˆ’ä¹¦](./settings_initialization_ui_plan.md)

---

*è®¡åˆ’ä¹¦ç»“æŸ*
