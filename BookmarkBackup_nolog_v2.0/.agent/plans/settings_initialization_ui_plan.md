# 「设置与初始化」模块 UI 设计计划书

> 创建时间：2026-01-07  
> 更新时间：2026-01-08 16:29  
> 状态：🔵 Phase 2.1 规划中（UI 重构：自动/手动备份切换整合）

---

## 一、概述

将原有的「初始化与重置按钮」区块重构为「设置与初始化」，增加备份设置功能，采用横向简洁的一级/二级列表布局，使用勾选方式进行选项配置。

### 实施范围

| 阶段 | 内容 | 状态 |
|------|------|------|
| **Phase 1** | 书签备份的基础设置（备份模式 + 覆盖策略） | ~~🟢 已实施~~ → 简化 |
| **Phase 1.1** | ~~设置联动约束（增量模式禁用覆盖）~~ | ⚫ 已移除 |
| **Phase 1.2** | 简化设置（移除增量模式，只保留覆盖策略） | 🟢 完成 |
| **Phase 2 UI** | 备份历史同步设置界面（堆叠式设计 + 折叠） | 🟢 完成 |
| **Phase 2 逻辑** | 备份历史自动同步后台逻辑 | 🟢 完成 |
| **Phase 2.1** | UI 重构：自动/手动备份切换整合到设置面板 | � 完成 |
| **Phase 3** | 同步与恢复功能 | 🟡 后续版本 |


---

## 二、标题更改

| 原标题 | 新标题 |
|--------|--------|
| 初始化与重置按钮 | 设置与初始化 |
| Initialization & Reset Buttons | Settings & Initialization |

---

## 三、UI 布局设计（Phase 1.2 简化后）

### 整体结构（横向一级/二级列表，紧凑布局）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 🔵 设置与初始化 / Settings & Initialization                            [▼] │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─ 备份设置 / Backup Settings ───────────────────────────────────────────┐│
│  │                                                                         ││
│  │  覆盖策略 / Overwrite Policy:                                           ││
│  │    ☑ 版本化 Versioned (带时间戳，多文件)                                 ││
│  │    ☐ 覆盖 Overwrite (单文件，GitHub友好)                                ││
│  │                                                                         ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
│  ┌─ 同步与恢复 / Sync & Restore (即将推出 / Coming Soon) ─────────────────┐│
│  │                                                                         ││
│  │    ☐ 从云端恢复 / Restore from Cloud     [禁用/Disabled]                ││
│  │    ☐ 冲突处理 / Conflict Resolution      [禁用/Disabled]                ││
│  │                                                                         ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
│  ┌─ 初始化操作 / Initialization Actions ──────────────────────────────────┐│
│  │                                                                         ││
│  │   ┌─────────────────────────┐    ┌─────────────────────────┐           ││
│  │   │   🔴 恢复到初始状态      │    │   🟢 初始化上传书签      │           ││
│  │   │   Reset to Initial      │    │   Initialize Upload     │           ││
│  │   └─────────────────────────┘    └─────────────────────────┘           ││
│  │        ↓ 点击弹出确认窗              ↓ 保持原有逻辑                      ││
│  │                                                                         ││
│  └─────────────────────────────────────────────────────────────────────────┘│
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、备份设置详细设计（Phase 1 核心）

> ⚠️ **2026-01-08 重大变更**
> 
> 移除「备份模式」和「增量详情」设置，原因：
> 1. 增量备份会导致恢复困难（需要从增量链条重建）
> 2. 增量记录功能与备份历史冲突（两者都记录变化）
> 3. 设置过于复杂，用户难以理解
> 
> **解决方案**：变化记录功能将在 Phase 2 的「备份历史自动同步」中实现

### 4.1 覆盖策略（唯一设置项）

| 选项 | 中文 | 英文 | 文件命名 | 适用场景 |
|------|------|------|----------|----------|
| `versioned` | 版本化 | Versioned | `bookmark_YYYY-MM-DD_HH_MM_SS.html` | 本地备份、WebDAV（保留历史版本） |
| `overwrite` | 覆盖 | Overwrite | `bookmark_backup.html` | GitHub仓库（单文件覆盖更新） |

**交互逻辑：**
- 默认选中「版本化」
- 两个选项互斥（单选）

### 4.2 已移除的设置项

以下设置项已在 2026-01-08 移除：

| 设置项 | 原有选项 | 移除原因 |
|--------|----------|----------|
| ~~备份模式~~ | ~~全量/增量~~ | 增量备份导致恢复困难 |
| ~~增量详情~~ | ~~简略/详情~~ | 与备份历史功能重复 |

### 4.3 新的设计方向

**书签备份**：每次都是完整备份（易于恢复）
**备份历史同步**：Phase 2 实现，负责变化记录的自动同步


## 五、各数据类型的覆盖策略（参考）

> 此部分为参考信息，Phase 1 只实现书签备份的设置

| 类型 | 建议覆盖策略 | 原因 | Phase 1 |
|------|-------------|------|---------|
| ① 书签备份 | **用户可选** | 核心功能，需要灵活配置 | ✅ 实现 |
| ② 当前变化 | 版本化 | 每次快照都不同 | ❌ 后续 |
| ③ 备份历史 | 版本化 | 历史记录需要保留 | ❌ 后续 |
| ④ 书签画布 | **覆盖** | 工作区域，只需最新状态 | ❌ 后续 |
| ⑤ 书签添加记录 | 版本化 | 日志性质，需要追溯 | ❌ 后续 |
| ⑥ 点击记录 | 版本化 | 日志性质，需要追溯 | ❌ 后续 |

---

## 六、同步与恢复（预留功能）

> ⚠️ 此功能**暂不实现**，仅预留 UI 位置，显示为禁用状态

### 6.1 从云端恢复 (Coming Soon)

**功能描述：**
- 检测云端是否存在备份数据
- 如有数据，提供「从云端恢复」选项
- 支持选择恢复点（版本化模式下）

### 6.2 冲突处理 (Coming Soon)

**功能描述：**
- 本地与云端数据存在差异时的处理策略
- 可选：保留本地 / 保留云端 / 合并

---

## 七、初始化操作（保持原有逻辑）

### 7.1 恢复到初始状态

- 按钮样式：红色危险按钮
- 点击后弹出现有的确认弹窗 (`resetConfirmDialog`)
- 功能：清除所有配置和备份记录，书签不受影响
- **不做修改**

### 7.2 初始化上传书签

- 按钮样式：绿色主要按钮
- **保持原有逻辑**（点击后执行初始化上传）
- 后续版本可扩展为选择目标弹窗

---

## 八、文件夹结构

### 8.1 原有结构 [原有]

```
书签快照 & 工具箱 导出 / Bookmark Git & Toolbox
├── 书签备份/           [原有] ← 书签自动/手动备份 HTML
├── 当前变化/           [原有] ← 当前变化导出 (HTML/JSON)
├── 备份历史/           [原有] ← 备份历史记录导出 (HTML/JSON/ZIP/MD)
├── 书签画布/           [原有] ← 书签画布导出 (JSON/ZIP)
├── 书签添加记录/        [原有] ← 书签添加记录导出 (HTML/JSON)
└── 点击记录/           [原有] ← 浏览历史导出 (HTML/JSON)
```

### 8.2 新增结构 [新增]

```
书签快照 & 工具箱 导出 / Bookmark Git & Toolbox
├── 书签备份/                    [原有]
│   ├── bookmark_2026-01-07_10_00.html    ← 版本化模式 [原有]
│   └── bookmark_backup.html              ← 覆盖模式 [新增]
│
├── 增量记录/                    [新增] ← 增量备份时的变化记录
│   ├── incremental_2026-01-07.html       ← 版本化模式
│   └── incremental_backup.html           ← 覆盖模式
│
├── 当前变化/                    [原有]
├── 备份历史/                    [原有]
├── 书签画布/                    [原有]
├── 书签添加记录/                 [原有]
└── 点击记录/                    [原有]
```

### 8.3 文件夹名称中英文对照

| 中文 | 英文 | 标记 |
|------|------|------|
| 书签备份 | Bookmark Backup | [原有] |
| 增量记录 | Incremental Log | [新增] |
| 当前变化 | Current Changes | [原有] |
| 备份历史 | Backup History | [原有] |
| 书签画布 | Bookmark Canvas | [原有] |
| 书签添加记录 | Bookmark Additions | [原有] |
| 点击记录 | Click History | [原有] |

---

## 九、存储结构 (Storage Keys)

```javascript
// 新增的设置项存储键
const BACKUP_SETTINGS_KEYS = {
    // 备份模式：'full' | 'incremental'
    BACKUP_MODE: 'backupMode',
    
    // 增量模式详情：'simple' | 'detailed'（仅增量模式时有效）
    INCREMENTAL_DETAIL: 'incrementalDetail',
    
    // 覆盖策略：'versioned' | 'overwrite'  
    OVERWRITE_MODE: 'overwriteMode',
};

// 默认值
const BACKUP_SETTINGS_DEFAULTS = {
    backupMode: 'full',
    incrementalDetail: 'simple',
    overwriteMode: 'versioned',
};
```

---

## 十、中英文 i18n 文案

### 10.1 区块标题

| Key | 中文 | 英文 |
|-----|------|------|
| `settingsInitTitle` | 设置与初始化 | Settings & Initialization |
| `backupSettingsTitle` | 备份设置 | Backup Settings |
| `syncRestoreTitle` | 同步与恢复 | Sync & Restore |
| `syncRestoreComingSoon` | 即将推出 | Coming Soon |
| `initActionsTitle` | 初始化操作 | Initialization Actions |

### 10.2 备份模式

| Key | 中文 | 英文 |
|-----|------|------|
| `backupModeLabel` | 备份模式 | Backup Mode |
| `backupModeFull` | 全量 | Full |
| `backupModeIncremental` | 增量 | Incremental |
| `incrementalDetailLabel` | 增量详情 | Incremental Detail |
| `incrementalSimple` | 简略 | Simple |
| `incrementalDetailed` | 详情 | Detailed |

### 10.3 覆盖策略

| Key | 中文 | 英文 |
|-----|------|------|
| `overwritePolicyLabel` | 覆盖策略 | Overwrite Policy |
| `overwriteVersioned` | 版本化 | Versioned |
| `overwriteVersionedDesc` | 带时间戳，多文件 | With timestamp, multiple files |
| `overwriteOverwrite` | 覆盖 | Overwrite |
| `overwriteOverwriteDesc` | 单文件，GitHub友好 | Single file, GitHub friendly |

### 10.4 同步与恢复

| Key | 中文 | 英文 |
|-----|------|------|
| `restoreFromCloud` | 从云端恢复 | Restore from Cloud |
| `conflictResolution` | 冲突处理 | Conflict Resolution |
| `featureDisabled` | 暂未启用 | Disabled |

### 10.5 初始化操作

| Key | 中文 | 英文 |
|-----|------|------|
| `resetToInitialBtn` | 恢复到初始状态 | Reset to Initial State |
| `initUploadBtn` | 初始化上传书签 | Initialize & Upload Bookmarks |

---

## 十一、实施步骤（Phase 1）

### Step 1: UI 结构修改
- [x] 1.1 修改区块标题「初始化与重置按钮」→「设置与初始化」
- [x] 1.2 添加「备份设置」子区块（勾选框方式）
- [x] 1.3 添加「同步与恢复」子区块（禁用状态预留）
- [x] 1.4 保持「初始化操作」子区块不变

### Step 2: CSS 样式
- [x] 2.1 添加新的样式类（勾选框、分隔线、禁用状态等）- 使用内联样式
- [x] 2.2 确保与现有主题兼容（明/暗模式）- 使用CSS变量

### Step 3: JavaScript 逻辑
- [x] 3.1 添加设置项的读取/保存逻辑
- [x] 3.2 添加勾选交互逻辑（互斥、启用/禁用联动）
- [x] 3.3.1 覆盖策略已实现（WebDAV/GitHub/本地三处均已修改）
- [x] 3.3.2 增量备份模式已实现（生成增量记录HTML并输出到各备份目标）

### Step 4: i18n 国际化
- [x] 4.1 添加中英文文案到 i18n 配置
- [x] 4.2 确保所有新增 UI 元素支持双语切换

---

## 十二、后续版本规划（Phase 2+）

### Phase 2: 备份历史自动同步（UI 重构 2026-01-08）

**UI 位置**：左侧面板（堆叠式分区设计）

**UI 结构：**
```
┌─ Bookmark Backup ───────────────────────────────────────────┐
│  Overwrite:  ☑ Versioned   ☐ Overwrite                      │
├─ Backup History ─────────────────────────────────── [开关] ─┤
│  Overwrite:  ☑ Versioned   ☐ Overwrite                      │
│  Format:     ☑ HTML        ☐ JSON                           │
│  View:       ☑ Simple      ☐ Detail                         │
└─────────────────────────────────────────────────────────────┘
```

**设置项：**

| 设置项 | 存储键 | 选项 | 说明 |
|--------|--------|------|------|
| 启用开关 | `historySyncEnabled` | `true`/`false` | 禁用后不自动同步备份历史 |
| 覆盖策略 | `historySyncOverwriteMode` | `versioned`/`overwrite` | 互斥单选，独立于书签备份 |
| 导出格式 | `historySyncFormat` | `html`/`json`/`both` | 可多选，至少选一个 |
| 视图模式 | `historySyncViewMode` | `simple`/`detailed` | 互斥单选 |

**格式与模式说明：**
- **HTML**：浏览器可导入的标准格式，参考全局导出的 HTML 生成
- **JSON**：结构化数据，包含完整的 `syncHistory` 信息
- **Simple**（简略）：只显示变化摘要统计
- **Detail**（详细）：显示具体的变化列表（带 `[+][-][~][↔]` 符号）

**输出策略（参考全局导出）：**
- **覆盖模式**：生成单一合并文件（参考「单一文件合并」）
- **版本化模式**：生成带时间戳的独立文件（类似 ZIP 解压后的多文件）

**实现步骤（已完成 2026-01-08）：**
- [x] 在 background.js 中实现 `exportSyncHistoryToCloud` 函数
- [x] 支持 HTML 格式导出（`generateSyncHistoryHtml` 函数）
- [x] 支持 JSON 格式导出（`generateSyncHistoryJson` 函数）
- [x] 根据书签备份的覆盖策略决定输出模式（版本化/覆盖）
- [x] 在每次书签备份后触发备份历史同步（`updateSyncStatus` 中异步调用）
- [x] 支持 WebDAV / GitHub / 本地下载三种目标
- [x] 添加 `backup_history` 文件夹映射到 `resolveExportSubFolderByKey`

**实现的函数：**
- `generateSyncHistoryHtml(syncHistory, viewMode, lang)` - 生成 HTML 表格
- `generateSyncHistoryJson(syncHistory, viewMode)` - 生成 JSON 数据
- `exportSyncHistoryToCloud(options)` - 主导出函数
- `uploadHistoryToWebDAV(...)` - WebDAV 上传
- `uploadHistoryToGitHub(...)` - GitHub 上传
- `downloadHistoryLocal(...)` - 本地下载

### Phase 2 其他功能（后续）

| 功能 | 说明 |
|------|------|
| 书签画布自动同步 | 覆盖策略（工作区域特性） |
| 书签添加记录自动同步 | 版本化策略 |
| 点击记录自动同步 | 版本化策略 |
| 多工作区支持 | 书签画布的多工作区管理 |

### Phase 3: 同步与恢复

| 功能 | 说明 |
|------|------|
| 从云端恢复 | 检测云端备份，选择恢复点 |
| 冲突处理 | 本地与云端差异处理策略 |
| 初始化目标选择 | 上传时选择云端1/云端2/本地 |

---

## 十三、注意事项

1. **兼容性**：确保修改不影响现有功能的正常使用
2. **默认值**：首次使用时应用默认设置（全量 + 版本化）
3. **迁移**：旧用户升级后应保持原有行为（默认全量 + 版本化）
4. **预留位置**：同步与恢复功能仅预留UI，功能后续开发
5. **简化优先**：Phase 1 保持简单，不做过度设计

---

## 十四、Phase 2.1 详细设计：UI 重构

> 规划时间：2026-01-08 16:29  
> 状态：� 已完成

### 核心变更

将主 UI 底部的「自动备份/手动备份」切换控件整合到「设置与初始化」面板中。

### 当前 UI 结构（待移除）

```
┌─────────────────────────────────────────────────────────────────────┐
│  ┌─ 自动备份 ─────┬─ 手动备份 ───────┐    ┌─ 状态卡片 ──────────┐  │
│  │  ⚙️设置       │  ⚙️ [手动备份]   │    │  自动备份模式    ▶  │  │
│  └────────────────┴──────────────────┘    └──────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

### 新 UI 结构

**1. 主 UI 区域（移除 slider，状态卡片加宽）**
```
┌─────────────────────────────────────────────────────────────────────┐
│  ┌─ 状态卡片（加宽，占满整行）──────────────────────────────────┐  │
│  │   自动备份模式 / 书签变化信息...                          ▶  │  │
│  │                                           [手动备份] ← 条件显示  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

**2. 设置与初始化面板（新增备份模式设置）**
```
┌─ Bookmark Backup ────────────────────────────────────────────────┐
│  Mode:       ☑ Auto         ☐ Manual                             │
│  Time:       [⚙️ 设置]  ← 根据 Mode 打开对应的时间设置弹窗 （放置在右边）│
│  Overwrite:  ☑ Versioned    ☐ Overwrite                          │
├─ Backup History (可折叠) ─────────────────────────────── [开关] ─┤
│  Overwrite:  ☑ Versioned    ☐ Overwrite                          │
│  Format:     ☑ HTML         ☐ JSON                               │
│  View:       ☑ Simple       ☐ Detail                             │
└───────────────────────────────────────────────────────────────────┘

Time 设置按钮根据 Mode 选择打开不同弹窗：
- ☑ Auto   → [⚙️ 设置] → 打开「自动备份设置」弹窗
- ☑ Manual → [⚙️ 设置] → 打开「动态提醒设置」弹窗
```

### UI 元素迁移表

| 元素 | 当前位置 | 新位置 | 说明 |
|------|---------|--------|------|
| 自动/手动切换 slider | 主 UI 底部 | 设置面板 `Mode:` 行 | 改为 checkbox 选择 |
| 自动备份设置按钮 ⚙️ | slider 左侧 | `Time:` 行（Auto 时） | 复用现有弹窗 |
| 动态提醒设置按钮 ⚙️ | slider 右侧 | `Time:` 行（Manual 时） | 复用现有弹窗 |
| 手动备份按钮 | slider 右侧 | 状态卡片右下角 | 仅手动模式显示 |

### 手动备份按钮设计

- **显示条件**：仅当选择「手动模式」时显示
- **位置**：状态卡片右下角
- **样式**：透明化，适应状态卡片背景色
  - 绿色状态卡片 → 绿色透明按钮
  - 橙色状态卡片 → 橙色透明按钮
  - 灰色状态卡片 → 灰色透明按钮
- **交互**：点击触发手动备份

### 状态卡片变更

- **功能保持**：点击查看详细变化（无变化）
- **宽度调整**：加宽占满第一行
- **新增元素**：右下角手动备份按钮（条件显示）

### 实现步骤（待做）

- [x] 1. 在设置面板「Bookmark Backup」区域添加 `Mode:` 行（Auto/Manual checkbox）
- [x] 2. 在 Mode 行下方添加设置按钮行（根据选择显示不同按钮）
- [x] 3. 实现设置按钮动态切换逻辑（Auto→自动备份设置 / Manual→动态提醒设置）
- [x] 4. 移除主 UI 底部的 slider 控件
- [x] 5. 调整状态卡片宽度（占满第一行）
- [x] 6. 在状态卡片右下角添加手动备份按钮
- [x] 7. 实现手动备份按钮颜色适应卡片背景（透明化）
- [x] 8. 实现 Mode 切换逻辑（显示/隐藏手动备份按钮 + 状态卡片文字）
- [x] 9. 测试功能完整性（确保所有弹窗、按钮功能正常）

### 设置存储（复用现有）

| 设置键 | 说明 |
|--------|------|
| `autoSyncEnabled` | 自动备份模式开关（已有） |
| `overwriteMode` | 覆盖策略（已有） |

---

---

## 十五、技术总结：本地备份覆盖策略 (Enhanced Overwrite Strategy)

>用于解决 Chrome 下载 API 无法直接覆盖同名文件的问题。

### 15.1 问题背景
Chrome 的 `downloads.download` API 出于安全考虑，当目标路径存在同名文件时，会自动重命名（如添加 `(1)`, `(2)` 后缀），无法实现真正的“覆盖”效果。

### 15.2 解决方案核心逻辑

采用 **"ID持久化 + 预删除"** 的策略：

1.  **持久化存储 ID**：
    *   每次本地备份成功后，将生成的 `downloadId` 写入 `chrome.storage.local` (Key: `lastLocalBackupId`)。
    *   不依赖内存中的 ID，防止 Browser 重启或 Service Worker 休眠导致 ID 丢失。

2.  **优先 ID 删除 (Primary Strategy)**：
    *   再次备份前，读取 `lastLocalBackupId`。
    *   使用 `chrome.downloads.search({id})` 确认文件是否仍在下载历史中。
    *   若存在，调用 `chrome.downloads.removeFile(id)` 删除物理文件，并调用 `chrome.downloads.erase({id})` 清除历史记录。

3.  **备选 搜索删除 (Fallback Strategy)**：
    *   如果 ID 无效（如用户清空了下载历史），回退到使用 `filenameRegex` 搜索同名文件。
    *   找到匹配项后尝试删除。

### 15.3 适用范围
*   目前已应用于：**书签本地备份 (Bookmark Backup - Local)** 的覆盖模式。
*   后续可推广至：**备份历史同步 (Backup History)** 的本地导出覆盖模式。

---

*计划书结束*
