# 书签Anki功能规划

## 〇、导航结构调整

### 当前结构
```
书签记录 (Bookmark toolbox)
├── 书签添加记录
├── 书签浏览记录
└── 书签Anki ← 移出
```

### 调整后结构
```
Bookmark Git
├── 当前 数量/结构 变化
└── 备份历史

Bookmark toolbox
├── Bookmark Canvas
├── 书签温故 (原"书签记录")
│   ├── 书签添加记录
│   └── 书签浏览记录
└── 书签推荐 ← 新增独立标签
    └── (Anki复习功能 + 权重配置)
```

### 涉及文件修改
| 文件 | 修改内容 |
|------|---------|
| history.html | 新增 `书签推荐` nav-tab，移除Anki子标签 |
| history.js | 新增 `recommendView` 视图切换逻辑 |
| history.css | 新增权重滑块样式 |
| i18n (如有) | 新增翻译 "书签推荐" / "Bookmark Recommend" |

---

## 一、权重公式设计

### 综合优先级公式

```
Priority = W1 × 新鲜度 + W2 × 冷门度 + W3 × 浅阅读度 + W4 × 遗忘度 + W5 × 用户标记
```

### 各因子计算

| 因子 | 公式 | 范围 | 说明 |
|------|------|------|------|
| **新鲜度** | `1 - min(添加天数 / 30, 1)` | 0~1 | 30天内的新书签优先 |
| **冷门度** | `1 - min(点击次数 / 10, 1)` | 0~1 | 点击<10次的优先 |
| **浅阅读度** | `1 - min(累计活跃时间 / 300000, 1)` | 0~1 | 活跃<5分钟的优先 |
| **遗忘度** | `min(距上次访问天数 / 14, 1)` | 0~1 | 超过14天未访问的优先 |
| **用户标记** | `isPinned ? 1 : 0` | 0/1 | 用户手动标记（v2.1） |

### 默认权重配置

```javascript
const DEFAULT_WEIGHTS = {
    W1_freshness: 0.15,      // 新鲜度权重
    W2_coldness: 0.25,       // 冷门度权重
    W3_shallowRead: 0.30,    // 浅阅读度权重（最重要）
    W4_forgetting: 0.25,     // 遗忘度权重
    W5_userMark: 0.05        // 用户标记权重（v2.1启用）
};
// 权重和 = 1.0
```

### 计算示例

```javascript
// 书签A：3天前添加，点击2次，活跃1分钟，7天未访问
新鲜度 = 1 - (3/30) = 0.90
冷门度 = 1 - (2/10) = 0.80
浅阅读度 = 1 - (60000/300000) = 0.80
遗忘度 = 7/14 = 0.50
用户标记 = 0

Priority = 0.15×0.90 + 0.25×0.80 + 0.30×0.80 + 0.25×0.50 + 0.05×0
         = 0.135 + 0.20 + 0.24 + 0.125 + 0
         = 0.70 (高优先级)
```

---

## 二、SM-2记忆曲线算法

### 复习评分与间隔

| 评分 | 含义 | 间隔调整 |
|:----:|------|---------|
| 0 | 完全忘记 | 重置为1天 |
| 1 | 困难 | interval × 1.2 |
| 2 | 一般 | interval × ease |
| 3 | 简单 | interval × ease × 1.3 |
| 4 | 太简单 | interval × ease × 1.5 |

### ease因子更新

```javascript
newEase = ease + (0.1 - (3 - rating) × (0.08 + (3 - rating) × 0.02))
// 最小值限制为1.3
```

---

## 三、数据结构

### 3.1 anki_cards 表 (IndexedDB)

```javascript
{
    bookmarkId: string,      // 主键，关联chrome.bookmarks
    url: string,
    title: string,
    
    // SM-2 算法字段
    ease: 2.5,               // 容易度因子 (≥1.3)
    interval: 1,             // 当前间隔(天)
    nextReview: timestamp,   // 下次复习时间
    
    // 统计字段
    totalActiveMs: 0,        // 累计活跃时间(毫秒)
    lastActiveTime: null,    // 最后活跃时间
    reviewCount: 0,          // 复习次数
    
    // 用户交互 (v2.1)
    isPinned: false,         // 固定/重要标记
    
    // 元数据
    createdAt: timestamp,
    updatedAt: timestamp
}
```

### 3.2 active_sessions 表 (IndexedDB)

```javascript
{
    id: string,              // 自动生成
    url: string,             // 页面URL
    tabId: number,           // 标签页ID
    startTime: timestamp,    // 开始活跃时间
    endTime: timestamp,      // 结束活跃时间
    duration: number,        // 持续时间(毫秒)
    isBookmark: boolean      // 是否为书签URL
}
```

---

## 四、实现计划

> **Phase 1 详细方案**：参见 [ACTIVE_TIME_TRACKING_PLAN.md](./ACTIVE_TIME_TRACKING_PLAN.md)

### v2.0 - 当前版本

| 阶段 | 任务 | 文件 | 状态 |
|:----:|------|------|:----:|
| Phase 0 | 导航结构调整：新增「书签推荐」标签 | history.html, history.js | 待开发 |
| Phase 1 | 活跃时间追踪（详见子文档） | background.js | 待开发 |
| Phase 2 | Anki数据库 + SM-2算法 | history_html/anki_database.js | 待开发 |
| Phase 3 | 权重配置UI + 推荐列表 | history_html/recommend_panel.js | 待开发 |

### v2.1 - 下一版本（待做）

| 功能 | 说明 | 优先级 |
|------|------|:------:|
| 画布专题复习 | 从Canvas临时节点筛选书签进行专题复习 | P1 |
| 手动标记重要 | 右键菜单/星标按钮标记书签为重要，影响权重 | P1 |
| 推荐提醒弹窗 | 复用backup_reminder机制，定时提醒查看推荐书签 | P1 |
| 复习评分细化 | 5级评分（忘记/困难/一般/简单/太简单） | P2 |
| 批量导入Anki | 将书签导出为Anki apkg格式 | P3 |
| 复习统计热力图 | 类似GitHub贡献图的复习记录可视化 | P3 |

---

## 五、「书签推荐」页面布局

### 整体布局

```
┌──────────────────────────────────────────────────────────────────┐
│  书签推荐                                            [?] [设置]  │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──── A区：推荐公式 ────────────────────────────────────────┐   │
│  │                                                           │   │
│  │  P = [0.15]×F + [0.25]×C + [0.30]×S + [0.25]×D           │   │
│  │      ─────    ─────    ─────    ─────                    │   │
│  │      新鲜度    冷门度   浅阅读    遗忘度                    │   │
│  │                                                           │   │
│  │  F = 1 - 添加天数/[30]天   C = 1 - 点击数/[10]次          │   │
│  │  S = 1 - 活跃时间/[5]分钟  D = 未访问天数/[14]天          │   │
│  │                                          [恢复默认]       │   │
│  └───────────────────────────────────────────────────────────┘   │
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──── B区：推荐卡片（Anki风格）─────────────────────────────┐   │
│  │                                                           │   │
│  │                    ┌─────────────────────┐                │   │
│  │                    │                     │                │   │
│  │                    │       📖            │                │   │
│  │                    │                     │                │   │
│  │                    │  「书签标题」        │  ← 点击翻转    │   │
│  │                    │                     │                │   │
│  │                    │     P = 0.85        │                │   │
│  │                    │                     │                │   │
│  │                    └─────────────────────┘                │   │
│  │                                                           │   │
│  │          [上一个]              [下一个]    [随机]          │   │
│  │                                                           │   │
│  │  ──────────────────────────────────────────────────────   │   │
│  │                                                           │   │
│  │     [打开]    [感兴趣]    [不感兴趣]    [已了解]          │   │
│  │                                                           │   │
│  └───────────────────────────────────────────────────────────┘   │
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──── C区：热力图（可折叠）─────────────────────────────────┐   │
│  │   书签浏览热力图                                          │   │
│  │   ┌─────────────────────────────────────────────────┐    │   │
│  │   │  一  二  三  四  五  六  日                      │    │   │
│  │   │  ▓▓  ░░  ▓▓  ▓▓  ░░  ▓   ░░   本周             │    │   │
│  │   │  ░░  ▓▓  ▓   ░░  ▓▓  ░░  ░░   上周             │    │   │
│  │   └─────────────────────────────────────────────────┘    │   │
│  │   ░ 0次  ▓ 1-3次  ▓▓ 4+次                                │   │
│  └───────────────────────────────────────────────────────────┘   │
│                                                                  │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──── D区：时间捕捉（可折叠）──────────── [追踪: ● 开启] ───┐   │
│  │                                                           │   │
│  │  📖 正在追踪的书签 (3)                                     │   │
│  │  ┌─────────────────────────────────────────────────────┐  │   │
│  │  │ 🟢 如何学习编程      ⏱ 03:25  暂停2次  活跃92%     │  │   │
│  │  │ 🟡 React文档         ⏱ 15:30  暂停8次  活跃45%     │  │   │
│  │  │ 🟡 某PDF手册         ⏱ 48:12  暂停23次 活跃8% ⚠挂机│  │   │
│  │  └─────────────────────────────────────────────────────┘  │   │
│  │                                                           │   │
│  │  ⏱ 活跃时间排行                              [本周 ▼]    │   │
│  │  ┌─────────────────────────────────────────────────────┐  │   │
│  │  │ 1. GitHub文档     2h15m  暂停5次  活跃78% █████████ │  │   │
│  │  │ 2. MDN Web Docs   1h42m  暂停12次 活跃52% ███████   │  │   │
│  │  │ 3. Stack Overflow 58m    暂停28次 活跃35% █████     │  │   │
│  │  └─────────────────────────────────────────────────────┘  │   │
│  │                                                           │   │
│  └───────────────────────────────────────────────────────────┘   │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

### 卡片翻转效果

```
          正面                              背面
┌─────────────────────┐           ┌─────────────────────┐
│                     │           │                     │
│       📖            │           │  example.com/...    │
│                     │   点击    │                     │
│ 「如何学习编程」     │  ──────►  │  添加于: 7天前      │
│                     │   翻转    │  点击: 2次          │
│     P = 0.85        │           │  活跃: 1分钟        │
│                     │           │  未访问: 5天        │
└─────────────────────┘           └─────────────────────┘
```

### 公式参数编辑

`[0.15]` 带框数字可点击编辑：
- 点击后变成输入框，可输入 0.00-1.00
- 或下拉选择预设值
- 修改后自动归一化（总和=100%）

### 卡片底部按钮

| 按钮 | 效果 | 对算法影响 |
|------|------|-----------|
| 打开 | 新标签页打开 | 记录点击 |
| 感兴趣 | 提高推荐权重 | 间隔缩短 |
| 不感兴趣 | 降低推荐权重 | 间隔延长 |
| 已了解 | 暂时不推荐 | 标记掌握 |

---

## 六、D区：时间捕捉UI

> 详细方案参见 [ACTIVE_TIME_TRACKING_PLAN.md](./ACTIVE_TIME_TRACKING_PLAN.md)

### 设计原则

- **简化分类**：不自动判断阅读/参考/工具，只判定「挂机」
- **展示原始数据**：活跃时间、暂停次数、活跃占比，让用户自行判断
- **追踪开关**：关闭后公式中的S(浅阅读度)权重变0

### 追踪开关与公式联动

```
追踪开启时：
P = [0.15]×F + [0.25]×C + [0.30]×S + [0.25]×D
                         ─────
                         浅阅读（生效）

追踪关闭时（自动归一化）：
P = [0.20]×F + [0.33]×C + [0̶.̶0̶0̶]̶×̶S̶ + [0.33]×D
                         ~~~~~~
                         浅阅读=0（删除线样式）
```

### 状态指示器

| 图标 | 状态 | 说明 |
|:----:|------|------|
| 🟢 | 活跃中 | 当前标签页在前台 |
| 🟡 | 已暂停 | 标签页失焦/切换到其他标签 |
| ⚠挂机 | 挂机页面 | 总时长>30分钟 且 活跃占比<15% |

### 列表项显示内容

每个条目紧凑显示：
- **书签标题**（点击可切换到该标签页）
- **活跃时间**：`⏱ HH:mm` 或 `XXm`
- **暂停次数**：`暂停N次`
- **活跃占比**：`活跃XX%`
- **挂机标记**：符合条件时显示 `⚠挂机`

### 交互功能

| 操作 | 功能 |
|------|------|
| 点击书签行 | 切换到该标签页 |
| 点击「追踪: ● 开启」 | 切换追踪状态，影响公式 |
| 时间范围下拉 | 切换 今天/本周/本月/全部 |
| 点击排行项 | 展开详细时间线 |

---

## 七、技术依赖

| 依赖 | 用途 | 现有? |
|------|------|:----:|
| chrome.tabs API | 活跃时间追踪 | ✅ |
| chrome.history API | 点击次数/访问时间 | ✅ |
| chrome.bookmarks API | 书签数据 | ✅ |
| IndexedDB | Anki数据持久化 | ✅ |
| chrome.alarms API | 定时提醒 | ✅ |
| notification_popup | 提醒弹窗 | ✅ |

---

## 更新日志

- 2024-XX-XX: 初始规划文档创建
