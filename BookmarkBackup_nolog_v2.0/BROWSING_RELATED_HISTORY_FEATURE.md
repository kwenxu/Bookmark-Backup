# 书签关联记录功能说明

## 功能概述

「书签关联记录」是一个新的子标签，位于「书签浏览记录」视图中，在「点击排行」的右侧。它的主要功能是：

1. **显示浏览器历史记录**：按时间范围（当天/当周/当月/当年）显示浏览器历史记录
2. **标识书签相关记录**：用黄色边框和特殊标识凸显书签相关的历史记录
3. **纵向多列布局**：使用 CSS Grid 自动适应窗口大小，显示尽可能多的纵列

## 实现细节

### HTML 结构
- 在 `browsing-sub-tabs` 中添加了新标签按钮 `browsingTabRelated`
- 创建了新面板 `browsingRelatedPanel`，包含：
  - 标题和描述
  - 时间筛选按钮（当天/当周/当月/当年）
  - 历史记录列表容器 `browsingRelatedList`

### CSS 样式
- `.related-history-list`：使用 Grid 布局，自适应列数
- `.related-history-item`：单个历史记录卡片
- `.related-history-item.is-bookmark`：书签相关的记录，带有：
  - 2px 黄色边框 (#fbbf24)
  - 淡黄色渐变背景
  - 右上角黄色圆点指示器
  - Hover 时增强的黄色阴影效果

### JavaScript 功能

#### 主要函数

1. **`initBrowsingRelatedHistory()`**
   - 初始化书签关联记录功能
   - 绑定时间筛选按钮事件
   - 绑定排序按钮事件
   - 恢复上次选择的时间范围

2. **`loadBrowsingRelatedHistory(range)`**
   - 加载指定时间范围的历史记录
   - 调用浏览器 History API 获取数据
   - 使用 URL + 标题双重匹配识别书签相关记录
   - 支持正序/倒序排序

3. **`getBookmarkUrlsAndTitles()`**
   - 同时获取当前所有书签的 URL 和标题集合
   - 标题会去除首尾空白后存储
   - 缓存结果以提高性能

4. **`renderBrowsingRelatedList(container, historyItems, bookmarkUrls, bookmarkTitles, range)`**
   - 渲染历史记录列表
   - 使用 URL 或标题匹配识别书签（并集逻辑）
   - 为书签相关的记录添加特殊样式
   - 显示序号、favicon 和智能时间格式

5. **`formatTimeByRange(date, range)`**
   - 根据时间范围智能格式化时间
   - 当天：只显示时间
   - 当周：显示周几+时间
   - 当月/当年：显示月-日+时间
   - 支持中英文

6. **`refreshBrowsingRelatedHistory()`**
   - 刷新当前显示的历史记录
   - 清除所有缓存（URL、标题、历史记录）并重新加载

#### 匹配算法

使用 **URL 或标题匹配（并集逻辑）**：

```javascript
// 条件1：URL匹配
if (bookmarkUrls.has(item.url)) {
    isBookmark = true;
}
// 条件2：标题匹配（去除空白后比较）
if (!isBookmark && item.title && item.title.trim() && bookmarkTitles.has(item.title.trim())) {
    isBookmark = true;
}
```

**优势**：
- 书签被删除后重新添加，即使URL略有变化也能匹配
- 网站改版导致URL变化但标题不变时仍能识别
- 与「点击记录」功能使用相同的匹配逻辑，保持一致性

### 国际化支持

添加了以下国际化文本：
- `browsingTabRelated`: 标签名称
- `browsingRelatedTitle`: 面板标题
- `browsingRelatedDescription`: 面板描述
- `browsingRelatedLoadingText`: 加载提示
- `browsingRelatedFilter*`: 时间筛选按钮文本

## 使用方法

1. 打开插件的历史查看器页面
2. 点击左侧导航的「书签温故」
3. 点击「书签浏览记录」标签
4. 点击「书签关联记录」子标签
5. 使用顶部的时间筛选按钮切换显示范围

## 特色功能

### 序号标识
- 每条记录左上角显示序号（1、2、3...）
- 普通记录：灰色圆形徽章
- 书签记录：黄色渐变圆形徽章，更加醒目

### 黄色边框标识
- 书签相关的历史记录会用醒目的黄色边框标识
- 右上角有黄色圆点指示器
- 底部显示「书签」徽章
- Hover 时有增强的视觉反馈

### 纵向多列布局
- 自动适应窗口大小
- 最小列宽 280px
- 间距 12px
- 支持垂直滚动

### 时间格式智能显示
根据选择的时间范围显示不同的时间格式：
- **当天**：只显示时间（如 `14:30`）
- **当周**：显示周几+时间（如 `周一 14:30` 或 `Mon 14:30`）
- **当月**：显示月-日+时间（如 `11-24 14:30`）
- **当年**：显示月-日+时间（如 `11-24 14:30`）

### 排序功能
- 点击左侧的排序按钮可切换正序/倒序
- **倒序**（默认）：显示最新的记录在前（图标向下）
- **正序**：显示最早的记录在前（图标向上翻转）
- 排序状态在切换时间范围时保持

### 性能优化
- 书签 URL 集合缓存
- Favicon 缓存复用
- 最多显示 500 条历史记录

## 测试建议

1. **基本功能测试**
   - 切换时间范围（当天/当周/当月/当年）
   - 验证历史记录正确显示
   - 验证书签记录被正确标识

2. **UI 测试**
   - 调整窗口大小，验证多列布局自适应
   - 验证黄色边框和圆点指示器显示
   - 验证 Hover 效果
   - 验证空状态显示

3. **国际化测试**
   - 切换语言（中文/英文）
   - 验证所有文本正确翻译

4. **性能测试**
   - 测试大量历史记录的加载速度
   - 验证缓存机制工作正常

## 依赖

- Chrome/Edge History API
- Chrome/Edge Bookmarks API
- FaviconCache（如果可用）
- 现有的国际化系统

## 注意事项

1. 需要浏览器的 `history` 权限
2. 最多显示 500 条历史记录（可在代码中调整）
3. Favicon 加载可能受 CORS 限制影响

## 更新日志

### 2025-11-24 v2.1
- **重要**：采用 URL + 标题双重匹配算法（与点击记录保持一致）
- 修改 `getBookmarkUrlsAndTitles()` 同时收集URL和标题
- 修改匹配逻辑：URL或标题任一匹配即可识别为书签
- 提高书签识别准确性，支持书签重新添加、URL变化等场景

### 2025-11-24 v2.0
- 添加序号标识（左上角圆形徽章，书签记录为黄色渐变）
- 添加正序/倒序排序按钮
- 实现智能时间格式显示（根据时间范围自动调整）
- 移除URL显示，界面更简洁
- 优化视觉效果和用户体验

### 2025-11-24 v1
- 初始实现书签关联记录功能
- 添加纵向多列布局
- 实现黄色边框标识书签相关记录
- 添加时间筛选功能（当天/当周/当月/当年）
- 集成浏览器历史记录 API
- 添加完整的国际化支持
