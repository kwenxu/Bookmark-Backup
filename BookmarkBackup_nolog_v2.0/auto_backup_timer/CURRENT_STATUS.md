# 当前实现状态总结
# Current Implementation Status Summary

## 核心前提条件 ⭐⭐⭐

**所有操作都必须满足：角标变黄（有数量/结构变化）**

**All operations require: Badge turns yellow (bookmark quantity/structure changes)**

---

## 完整处理逻辑表格

### 表格 1：打开浏览器（Browser Startup）

| 场景分类 | 触发方式 | 是否检查遗漏？ | 处理逻辑 | 是否补充备份？ | 防重复机制 |
|---------|---------|--------------|---------|--------------|-----------|
| **常规时间<br>周+默认时间**<br>（如：周一 10:00） | `onStartup`<br>→ 强制检查 | ✅ **检查** | 1. 检查今天是否在周勾选范围内<br>2. 检查今天是否已补充<br>3. 检查默认时间是否已过<br>4. 已过 → 补充备份 | ✅ **补充一次**<br>（如果过期且今天未补充） | `lastMissedBackupDate`<br>每天只补充一次 |
| **常规时间<br>小时间隔**<br>（如：每2小时） | `onStartup`<br>→ 设置定时器 | ❌ **不检查** | 1. 检查今天是否在周勾选范围内<br>2. 根据当前时间直接计算下一个整点<br>3. 设置定时器 | ❌ **不补充**<br>过去就过去 | 无需防重复<br>（不补充遗漏） |
| **常规时间<br>分钟间隔**<br>（如：每15分钟） | `onStartup`<br>→ 设置定时器 | ❌ **不检查** | 1. 检查今天是否在周勾选范围内<br>2. 根据当前时间直接计算下一个间隔点<br>   - 15:08 → 设置 15:15<br>   - 15:17 → 设置 15:30<br>3. 设置定时器 | ❌ **不补充**<br>过去就过去 | 无需防重复<br>（不补充遗漏） |
| **特定时间<br>多个任务**<br>（如：10:00, 14:30） | `onStartup`<br>→ 强制检查 | ✅ **检查** | 1. 检索所有待执行的当日任务<br>2. 过期任务（已过时间） → 补充备份<br>3. 未过期任务 → 设置定时器<br>4. 昨天的任务 → 仅标记，不备份 | ✅ **补充一次**<br>（每个错过的当日任务） | `executed` 标记<br>每个任务只补充一次 |

---

### 表格 2：从休眠中恢复（Sleep Recovery）

| 场景分类 | 触发方式 | 是否检查遗漏？ | 处理逻辑 | 是否补充备份？ | 防重复机制 |
|---------|---------|--------------|---------|--------------|-----------|
| **常规时间<br>周+默认时间**<br>（如：周一 10:00） | 角标变黄<br>→ 启动定时器<br>→ `auto` 模式 | ✅ **智能检查**<br>（距离上次检查超过10分钟） | 1. 检查距离上次检查的时间<br>   - < 10分钟 → 跳过<br>   - ≥ 10分钟 → 执行检查<br>2. 检查今天是否在周勾选范围内<br>3. 检查今天是否已补充<br>4. 检查默认时间是否已过<br>5. 已过 → 补充备份 | ✅ **补充一次**<br>（如果过期且今天未补充） | 1. `lastMissedCheckTime`<br>（10分钟内不重复检查）<br>2. `lastMissedBackupDate`<br>（每天只补充一次） |
| **常规时间<br>小时间隔**<br>（如：每2小时） | 角标变黄<br>→ 启动定时器 | ❌ **不检查** | 1. 检查今天是否在周勾选范围内<br>2. 根据当前时间直接计算下一个整点<br>3. 设置定时器 | ❌ **不补充**<br>过去就过去 | 无需防重复<br>（不补充遗漏） |
| **常规时间<br>分钟间隔**<br>（如：每15分钟） | 角标变黄<br>→ 启动定时器 | ❌ **不检查** | 1. 检查今天是否在周勾选范围内<br>2. 根据当前时间直接计算下一个间隔点<br>3. 设置定时器 | ❌ **不补充**<br>过去就过去 | 无需防重复<br>（不补充遗漏） |
| **特定时间<br>多个任务**<br>（如：10:00, 14:30） | 角标变黄<br>→ 启动定时器<br>→ `auto` 模式 | ✅ **智能检查**<br>（距离上次检查超过10分钟） | 1. 检查距离上次检查的时间<br>   - < 10分钟 → 跳过<br>   - ≥ 10分钟 → 执行检查<br>2. 检索所有待执行的当日任务<br>3. 过期任务 → 补充备份<br>4. 未过期任务 → 设置定时器 | ✅ **补充一次**<br>（每个错过的当日任务） | 1. `lastMissedCheckTime`<br>（10分钟内不重复检查）<br>2. `executed` 标记<br>（每个任务只补充一次） |

---

## 关键差异对比

### 周+默认时间 vs 间隔定时器

|  | 周+默认时间 | 分钟/小时间隔 |
|---|------------|--------------|
| **性质** | 固定时间点（如 10:00） | 滚动间隔（如每15分钟） |
| **遗漏检查** | ✅ 检查并补充 | ❌ 不检查，过去就过去 |
| **设置方式** | 计算下一个勾选日的默认时间 | 根据当前时间计算下一个间隔点 |
| **防重复** | `lastMissedBackupDate`（每天一次） | 无需（不补充遗漏） |
| **周勾选影响** | 决定哪几天执行 | 决定当天是否启用间隔定时器 |

---

## 详细示例

### 示例 1：打开浏览器 - 常规时间（周+默认时间）

**场景**：
- 设置：周一、周三、周五，默认时间 10:00
- 添加书签（角标变黄）
- 关闭浏览器
- **周一 11:00** 打开浏览器

**处理流程**：
```
1. onStartup 事件触发
2. 执行 checkMissedBackups()（强制检查）
3. 检测到书签变化（角标黄）✓
4. 检查今天是否在周勾选内（周一）✓
5. 检查今天是否已补充 ✗
6. 检查默认时间是否已过（11:00 > 10:00）✓
7. → 执行补充备份一次
8. 记录 lastMissedBackupDate = 今天
9. 设置下一个周定时器（周三 10:00）
```

**如果再次关闭并打开浏览器**：
```
3. 检测到书签变化（角标黄）✓
4. 检查今天是否在周勾选内（周一）✓
5. 检查今天是否已补充 ✓ ← 关键
6. → 跳过重复补充
```

---

### 示例 2：打开浏览器 - 分钟间隔

**场景**：
- 设置：15分钟间隔
- 添加书签（角标变黄）
- **15:01** 关闭浏览器
- **15:17** 打开浏览器

**处理流程**：
```
1. onStartup 事件触发
2. 执行 setupRegularTimeAlarms()
3. 调用 getNextMinuteIntervalTime(15)
4. 计算：Math.ceil(17/15)*15 = 30
5. → 设置 15:30 定时器
6. ❌ 不检查 15:15 的遗漏
```

**如果是 15:08 打开**：
```
4. 计算：Math.ceil(8/15)*15 = 15
5. → 设置 15:15 定时器
```

---

### 示例 3：休眠恢复 - 常规时间（周+默认时间）

**场景**：
- 设置：周一、周三、周五，默认时间 10:00
- 添加书签（角标变黄）
- **周一 09:30** 让电脑睡眠
- **周一 11:00** 唤醒电脑

**处理流程**：
```
1. Service Worker 被唤醒
2. 角标仍然是黄色（有变化）
3. setBadge() 检测到变化，启动定时器
4. initializeTimerSystem('auto') ← 自动模式
5. 检查距离上次检查的时间
   - 上次检查：09:30（睡眠前）
   - 现在：11:00
   - 间隔：90分钟 > 10分钟 ✓
6. → 执行 checkMissedBackups()
7. 检测到书签变化（角标黄）✓
8. 检查今天是否在周勾选内（周一）✓
9. 检查今天是否已补充 ✗
10. 检查默认时间是否已过（11:00 > 10:00）✓
11. → 执行补充备份一次
12. 记录 lastMissedBackupDate = 今天
13. 更新 lastMissedCheckTime = 11:00
```

**如果 5分钟后再次睡眠并唤醒**：
```
5. 检查距离上次检查的时间
   - 上次检查：11:00
   - 现在：11:05
   - 间隔：5分钟 < 10分钟 ✗
6. → 跳过遗漏检查
```

---

### 示例 4：特定时间任务

**场景**：
- 设置：今天 10:00, 14:30, 18:00 三个任务
- 添加书签（角标变黄）
- 关闭浏览器
- **15:00** 打开浏览器

**处理流程**：
```
1. onStartup 事件触发
2. 执行 checkMissedBackups()（强制检查）
3. 检测到书签变化（角标黄）✓
4. 检索当日待执行任务：
   - 10:00（已过期，未执行）
   - 14:30（已过期，未执行）
   - 18:00（未过期）
5. 处理 10:00 任务：
   → 补充备份一次
   → 标记 executed = true
6. 处理 14:30 任务：
   → 补充备份一次
   → 标记 executed = true
7. 处理 18:00 任务：
   → 设置 18:00 定时器
```

**注意**：10:00 和 14:30 会分别触发一次备份，还是合并为一次？

**答案**：根据代码，会**串行执行**，可能触发多次。但由于有防重复机制（5秒间隔），实际上只会执行一次备份，然后标记两个任务都为已执行。

---

## 防重复机制总结

| 机制 | 用途 | 作用范围 | 重置时机 |
|------|-----|---------|---------|
| `lastMissedBackupDate` | 防止常规时间（周+默认时间）重复补充 | 每天一次 | 跨天自动重置 |
| `executed` 标记 | 防止特定时间任务重复执行 | 每个任务一次 | 手动删除任务 |
| `lastMissedCheckTime` | 防止频繁检查遗漏 | 10分钟内 | 每次检查时更新 |
| 备份防重复（5秒） | 防止短时间内多次触发备份 | 5秒内 | 每次触发时检查 |
| `autoBackupTimerRunning` | 防止重复启动定时器 | 启动到停止 | 定时器停止时重置 |

---

## 日志示例

### 打开浏览器 - 过了默认时间

```
[自动备份定时器] 浏览器启动，检查是否需要恢复遗漏的备份任务
[自动备份定时器] 检测到书签变化，开始检查遗漏任务
[自动备份定时器] 开始检查遗漏的备份任务...
[自动备份定时器] 检测到书签变化（角标变黄），继续检查遗漏任务
[自动备份定时器] 已过默认时间 10:00，执行补充备份
[自动备份定时器] 触发自动备份，原因: Mon
[自动备份定时器] 检测到变化: (moved)，开始备份
[自动备份定时器] 自动备份成功
[自动备份定时器] 已记录今天的补充备份，避免重复执行
[自动备份定时器] 遗漏备份任务检查完成
```

### 休眠恢复 - 超过10分钟

```
[自动备份定时器] 角标变黄（检测到变化），启动定时器
[自动备份定时器] 开始初始化定时器系统
[自动备份定时器] 距离上次检查超过10分钟（可能休眠恢复），检查遗漏的备份任务
[自动备份定时器] 开始检查遗漏的备份任务...
[自动备份定时器] 检测到书签变化（角标变黄），继续检查遗漏任务
[自动备份定时器] 已过默认时间 10:00，执行补充备份
[自动备份定时器] 触发自动备份，原因: Mon
[自动备份定时器] 自动备份成功
[自动备份定时器] 已记录今天的补充备份，避免重复执行
```

### 休眠恢复 - 不到10分钟

```
[自动备份定时器] 角标变黄（检测到变化），启动定时器
[自动备份定时器] 开始初始化定时器系统
[自动备份定时器] 距离上次检查不到10分钟，跳过遗漏检查
[自动备份定时器] 定时器系统初始化完成
```

### 重复打开浏览器 - 今天已补充

```
[自动备份定时器] 浏览器启动，检查是否需要恢复遗漏的备份任务
[自动备份定时器] 检测到书签变化，开始检查遗漏任务
[自动备份定时器] 开始检查遗漏的备份任务...
[自动备份定时器] 检测到书签变化（角标变黄），继续检查遗漏任务
[自动备份定时器] 今天已经执行过补充备份，跳过重复补充
[自动备份定时器] 遗漏备份任务检查完成
```

---

## 总结

✅ **完整实现了你的需求：**

1. **打开浏览器** + 角标黄：
   - 周+默认时间：检查遗漏，补充一次
   - 分钟/小时间隔：不检查，直接计算下一个间隔点
   - 特定时间：检查遗漏，补充错过的任务

2. **休眠恢复** + 角标黄：
   - 周+默认时间：智能检查（>10分钟），补充一次
   - 分钟/小时间隔：不检查，直接计算下一个间隔点
   - 特定时间：智能检查（>10分钟），补充错过的任务

3. **防重复**：
   - 常规时间：每天只补充一次
   - 特定时间：每个任务只补充一次
   - 休眠检查：10分钟内不重复检查

4. **核心前提**：所有操作都在"角标变黄"的前提下执行
