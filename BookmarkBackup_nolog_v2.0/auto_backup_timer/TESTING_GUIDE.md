# 自动备份定时器 - 测试指南
# Auto Backup Timer - Testing Guide

## 测试前准备

1. 确保浏览器扩展已加载最新代码
2. 打开浏览器控制台（F12）查看日志
3. 设置常规时间模式，启用分钟间隔（如每2分钟）方便测试

## 关键Bug修复验证

### Bug #1: 遗漏检查不应在角标变黄时触发

**测试步骤**：
1. 在浏览器运行中，添加一个书签
2. 观察控制台日志

**预期结果**：
```
✅ 应该看到：
[自动备份定时器] 角标变黄（检测到变化），启动定时器
timer.js [自动备份定时器] 开始初始化定时器系统
timer.js [自动备份定时器] 跳过遗漏检查（非浏览器启动）

❌ 不应该看到：
[自动备份定时器] 已过默认时间 10:00，执行补充备份
```

### Bug #2: 防止重复启动定时器

**测试步骤**：
1. 在浏览器运行中，添加一个书签
2. 观察控制台日志

**预期结果**：
```
✅ 应该只看到一次：
[自动备份定时器] 角标变黄（检测到变化），启动定时器
[自动备份定时器] 开始初始化定时器系统

✅ 可能看到防抖日志：
[setBadge] 防抖跳过，距离上次调用不到 200ms

❌ 不应该看到多次重复：
[自动备份定时器] 角标变黄（检测到变化），启动定时器 (重复4次)
```

### Bug #3: 备份成功后角标变绿

**测试步骤**：
1. 添加书签，角标变黄
2. 等待自动备份触发（或手动触发）
3. 备份成功后观察角标和控制台

**预期结果**：
```
✅ 应该看到：
[自动备份定时器] 自动备份成功
[自动备份定时器] 角标变绿（无变化），停止定时器

✅ 角标应该从黄色变为绿色
```

## 核心功能测试

### 测试 1: 浏览器启动时的遗漏检查

**场景**：关闭浏览器后，过了默认时间再打开

**前提条件**：⭐ 必须有书签变化（角标变黄）

**步骤**：
1. 设置默认时间为当前时间后5分钟（如现在10:00，设置10:05）
2. 添加书签让角标变黄 ← 关键步骤
3. 关闭浏览器
4. 等到10:10（过了默认时间）
5. 打开浏览器

**预期结果**：
```
[自动备份定时器] 浏览器启动，检查是否需要恢复遗漏的备份任务
[自动备份定时器] 检测到书签变化，开始检查遗漏任务
[自动备份定时器] 开始检查遗漏的备份任务...
[自动备份定时器] 检测到书签变化（角标变黄），继续检查遗漏任务
[自动备份定时器] 已过默认时间 10:05，执行补充备份
[自动备份定时器] 触发自动备份，原因: Mon (或对应的星期)
[自动备份定时器] 检测到变化: (描述)，开始备份
[syncBookmarks] 参数: ...
[自动备份定时器] 自动备份成功
[自动备份定时器] 已记录今天的补充备份，避免重复执行 ⭐
```

### 测试 1.1: 重复打开浏览器不重复补充（常规时间）⭐ **重要**

**场景**：在测试1基础上，关闭并重新打开浏览器

**步骤**：
1. 完成测试1（已执行过一次补充备份）
2. 关闭浏览器
3. 立即重新打开浏览器（仍然过了默认时间）

**预期结果**：
```
[自动备份定时器] 浏览器启动，检查是否需要恢复遗漏的备份任务
[自动备份定时器] 检测到书签变化，开始检查遗漏任务
[自动备份定时器] 开始检查遗漏的备份任务...
[自动备份定时器] 检测到书签变化（角标变黄），继续检查遗漏任务
[自动备份定时器] 今天已经执行过补充备份，跳过重复补充 ⭐
```

**不应该看到**：
```
❌ [自动备份定时器] 已过默认时间 10:05，执行补充备份
❌ [自动备份定时器] 触发自动备份...
```

### 测试 2: 浏览器启动时无变化（验证前提条件）⭐

**场景**：关闭浏览器后，没有添加书签，重新打开

**关键点**：验证"无变化时不执行遗漏检查"的前提条件

**步骤**：
1. 执行一次成功的备份（角标变绿）
2. 关闭浏览器（不添加任何书签）
3. 重新打开浏览器

**预期结果**：
```
[自动备份定时器] 浏览器启动，检查是否需要恢复遗漏的备份任务
[自动备份定时器] 无书签变化，跳过遗漏检查 ← 关键：直接跳过
```

**不应该看到**：
```
❌ [自动备份定时器] 开始检查遗漏的备份任务...
❌ [自动备份定时器] 已过默认时间...
```

### 测试 3: 间隔定时器智能计算

**场景**：关闭浏览器后，错过了一个间隔点

**步骤**：
1. 设置2分钟间隔
2. 添加书签（角标变黄，定时器启动）
3. 假设当前是 10:01，下一个间隔点是 10:02
4. 关闭浏览器
5. 在 10:03 打开浏览器

**预期结果**：
```
[自动备份定时器] 已设置分钟间隔定时器: 10:04:00 (直接跳到下一个间隔点)
```

**不应该**：
```
❌ 不应该补充 10:02 的备份
```

### 测试 4: 周勾选影响间隔定时器

**场景**：只勾选周一、周三、周五，在周二打开浏览器

**步骤**：
1. 设置常规时间，只勾选周一、周三、周五
2. 添加书签让角标变黄
3. 在周二关闭并重新打开浏览器

**预期结果**：
```
[自动备份定时器] 今天(周二)未在周勾选范围内，跳过常规时间遗漏检查
```

**不应该**：
```
❌ 不应该设置分钟/小时间隔定时器
```

### 测试 5: 跨天停止间隔定时器

**场景**：分钟间隔定时器在午夜前触发

**步骤**：
1. 设置30分钟间隔
2. 等到 23:45 左右
3. 等待定时器触发

**预期结果**：
```
[自动备份定时器] 下一个分钟间隔已跨天，停止定时器，等待周定时器重新设置
```

### 测试 6: 防重复触发机制

**场景**：快速连续添加多个书签

**步骤**：
1. 快速连续添加3个书签

**预期结果**：
```
[自动备份定时器] 触发自动备份，原因: ...
[自动备份定时器] 检测到变化: ...，开始备份
[syncBookmarks] 参数: ...

(后续触发被跳过)
[自动备份定时器] 备份正在进行中，跳过本次触发
或
[自动备份定时器] 距离上次备份触发不到5秒，跳过本次触发
```

### 测试 7: 特定时间任务遗漏

**场景**：设置今天某个时间的特定任务，错过后打开浏览器

**步骤**：
1. 切换到特定时间模式
2. 添加今天 10:00 的特定任务
3. 添加书签让角标变黄
4. 关闭浏览器
5. 在 10:30 打开浏览器

**预期结果**：
```
[自动备份定时器] 发现当日遗漏的特定时间任务: 2024-10-04T10:00
[自动备份定时器] 触发自动备份，原因: 特定：2024-10-04 10:00
[自动备份定时器] 自动备份成功
```

### 测试 7.1: 重复打开浏览器不重复补充（特定时间）⭐ **重要**

**场景**：在测试7基础上，关闭并重新打开浏览器

**步骤**：
1. 完成测试7（已执行过一次特定时间的补充备份）
2. 关闭浏览器
3. 立即重新打开浏览器

**预期结果**：
```
[自动备份定时器] 浏览器启动，检查是否需要恢复遗漏的备份任务
[自动备份定时器] 检测到书签变化，开始检查遗漏任务
[自动备份定时器] 开始检查遗漏的备份任务...
[自动备份定时器] 遗漏备份任务检查完成 (没有找到待执行的任务)
```

**不应该看到**：
```
❌ [自动备份定时器] 发现当日遗漏的特定时间任务...
❌ [自动备份定时器] 触发自动备份...
```

## 性能验证

### 检查点 1: 无冗余定时器

打开浏览器控制台，执行：
```javascript
chrome.alarms.getAll((alarms) => {
    console.log('活跃的定时器:', alarms);
});
```

**预期**：
- 最多应该看到 3 个定时器（周定时器 + 间隔定时器 + 特定时间定时器）
- 不应该有重复的定时器

### 检查点 2: 内存使用

观察浏览器任务管理器，扩展的内存使用应该稳定，不应该持续增长。

## 日志关键词检索

在控制台使用过滤器，快速定位问题：

- `[自动备份定时器]` - 所有定时器相关日志
- `角标变黄` - 定时器启动时机
- `遗漏` - 遗漏检查相关
- `跳过` - 被跳过的操作
- `重复` 或 `防抖` - 重复执行防护

## 常见问题排查

### 问题：遗漏检查在角标变黄时触发

**症状**：
```
[自动备份定时器] 角标变黄（检测到变化），启动定时器
[自动备份定时器] 已过默认时间 10:00，执行补充备份 (不应该出现)
```

**原因**：代码未正确更新

**解决**：确保 `setBadge()` 中调用 `initializeAutoBackupTimerSystem(false)`

### 问题：定时器重复启动

**症状**：
```
[自动备份定时器] 角标变黄（检测到变化），启动定时器 (出现4次)
```

**原因**：`setBadge()` 被频繁调用且没有防抖

**解决**：确保防抖机制已添加

### 问题：备份成功后角标还是黄色

**症状**：
```
[自动备份定时器] 自动备份成功
(角标仍然是黄色)
```

**原因**：`lastCalculatedDiff` 未正确重置

**解决**：
1. 检查 `updateSyncStatus()` 中是否重置了差异值
2. 检查 `updateAndCacheAnalysis()` 是否被调用
3. 检查 `setBadge()` 是否重新检查了变化状态

## 测试清单

完成以下测试后，在旁边打勾：

- [ ] Bug #1: 遗漏检查不在角标变黄时触发
- [ ] Bug #2: 无重复启动定时器
- [ ] Bug #3: 备份成功后角标变绿
- [ ] 测试 1: 浏览器启动时遗漏检查（有变化）
- [ ] **测试 1.1: 重复打开不重复补充（常规时间）⭐**
- [ ] 测试 2: 浏览器启动时无遗漏检查（无变化）
- [ ] 测试 3: 间隔定时器智能计算
- [ ] 测试 4: 周勾选影响间隔定时器
- [ ] 测试 5: 跨天停止间隔定时器
- [ ] 测试 6: 防重复触发机制
- [ ] 测试 7: 特定时间任务遗漏
- [ ] **测试 7.1: 重复打开不重复补充（特定时间）⭐**
- [ ] 性能 1: 无冗余定时器
- [ ] 性能 2: 内存使用稳定

---

**如果所有测试通过，说明智能恢复机制已正确实现！**
