# 备份历史清理功能说明

## 功能概述

本扩展提供了灵活的备份历史记录清理功能，允许用户按百分比或按条数删除最旧的记录，同时保持序号的连续性。

## 主要特性

### 1. 灵活的删除方式

- **按百分比删除**：选择删除最旧的 10% ~ 100% 记录（步进 10%），默认 50%
- **按条数删除**：直接输入要删除的记录数量

### 2. 序号保持机制

- **永久序号**：每条记录创建时会分配一个永久序号（`seqNumber`）
- **部分删除后序号延续**：删除部分记录后，新记录的序号会在历史最大序号基础上 +1，不会重新从 1 开始
- **全部清除时重置**：只有清空所有历史记录后，新记录的序号才会从 1 重新开始

### 3. 二次确认与备份提醒

点击"确认删除"后会弹出二次确认窗口，提供三个选项：
- **先备份这些记录**：跳转到全局导出页面，自动预选将被删除的记录
- **直接删除**：立即执行删除操作
- **返回修改**：返回主界面继续调整删除数量

### 4. 实时预览

在选择删除数量时，界面会实时显示"当前共 X 条记录，将删除 Y 条"的预览信息。

## 序号示例

假设当前有 10 条记录，序号为 1~10：

| 操作 | 删除记录 | 剩余记录 | 新记录序号 |
|------|---------|---------|-----------|
| 删除最旧的 3 条 | 1, 2, 3 | 4~10 | 11, 12, 13... |
| 再删除 2 条 | 4, 5 | 6~10 | 继续从 11 开始（如果之前没有新增） |
| 全部清除 | 全部 | 无 | 1 |

## 技术说明

### 存储结构

每条同步记录包含：
```javascript
{
  time: 1704499200000,        // 时间戳
  seqNumber: 42,              // 永久序号
  direction: 'upload',        // 备份方向
  type: 'auto',               // 备份类型
  status: 'success',          // 状态
  bookmarkStats: {...},       // 书签统计
  bookmarkTree: [...],        // 书签树（可选）
  fingerprint: 'a1b2c3d4',    // 指纹
  note: '手动备份'             // 备注
}
```

### 删除逻辑

1. 计算要删除的数量（基于百分比或条数）
2. 从最旧的记录开始删除
3. 找到被删除记录中最新的有效书签树，作为后续对比的基准
4. 更新存储

### 兼容性

对于升级前的旧记录（没有 `seqNumber` 字段），系统会自动回退到计算序号的方式：
```javascript
const seqNumber = record.seqNumber || (totalRecords - globalIndex);
```

## 相关文件

- `background.js`：消息处理器 `clearSyncHistoryPartial`
- `history.html`：清除历史弹窗 UI
- `history.js`：清除历史弹窗逻辑和序号显示
- `popup.js`：主界面历史记录序号显示

---

*最后更新：2026-01-06*
