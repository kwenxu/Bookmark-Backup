# 书签推荐 & 书签记录 存储占用估算

## 假设条件

- 书签数量：1000 个
- 每天打开主UI：5 次
- 每天访问书签页面：20 次
- 半年时间：180 天
- 待复习队列最大：50 个
- 屏蔽书签最大：100 个

---

## 一、书签推荐 (Bookmark Recommend)

### 1.1 S值缓存 `recommend_scores_cache`

```javascript
// 每个书签的缓存结构
{
    "bookmarkId": {
        "S": 0.75,      // 8 bytes
        "F": 0.85,      // 8 bytes
        "C": 0.60,      // 8 bytes
        "T": 0.45,      // 8 bytes
        "D": 0.70,      // 8 bytes
        "L": 0.00,      // 8 bytes
        "R": 1.00       // 8 bytes
    }
}
// 每条约 100 bytes（含JSON格式开销）
```

| 书签数 | 大小 |
|:------:|------|
| 100 | ~10 KB |
| 500 | ~50 KB |
| 1000 | ~100 KB |
| 5000 | ~500 KB |

**半年变化**：大小随书签数量变化，不随时间累积

---

### 1.2 待复习队列 `recommend_postponed`

```javascript
// 每条约 80 bytes
{
    "bookmarkId": "123",
    "postponeTime": 1699999999999,
    "reviewTime": 1700000000000,
    "manuallyAdded": true
}
```

| 数量 | 大小 |
|:----:|------|
| 10 | ~0.8 KB |
| 50 | ~4 KB |
| 100 | ~8 KB |

**半年变化**：自动过期清理，通常保持 <50 条

---

### 1.3 屏蔽列表 `recommend_blocked`

```javascript
{
    "bookmarks": ["id1", "id2", ...],  // 书签ID数组
    "folders": ["fid1", ...],           // 文件夹ID数组
    "domains": ["example.com", ...]     // 域名数组
}
// 每个ID约 10 bytes，每个域名约 20 bytes
```

| 内容 | 大小 |
|------|------|
| 50 书签 + 5 文件夹 + 10 域名 | ~0.8 KB |
| 100 书签 + 10 文件夹 + 20 域名 | ~1.5 KB |

**半年变化**：随用户操作累积，通常 <2 KB

---

### 1.4 已翻阅记录 `flippedBookmarks`

```javascript
// 每条约 25 bytes
{ "bookmarkId": 1699999999999 }  // ID: 时间戳
```

| 每天翻阅 | 半年累积 | 大小 |
|:--------:|:--------:|------|
| 5 张 | 900 条 | ~22 KB |
| 10 张 | 1800 条 | ~45 KB |
| 20 张 | 3600 条 | ~90 KB |

**注意**：代码中有1000条限制，自动裁剪

---

### 1.5 复习数据 `recommend_reviews`

```javascript
// 每条约 60 bytes
{
    "bookmarkId": {
        "lastReview": 1699999999999,
        "reviewCount": 5,
        "interval": 7
    }
}
```

| 复习书签数 | 大小 |
|:----------:|------|
| 100 | ~6 KB |
| 500 | ~30 KB |
| 1000 | ~60 KB |

**半年变化**：随复习书签数增加

---

### 1.6 其他小型存储

| 存储项 | 大小 | 说明 |
|--------|------|------|
| `recommendFormulaConfig` | ~0.5 KB | 权重和阈值配置 |
| `popupCurrentCards` | ~2 KB | 当前显示的3张卡片 |
| `recommendRefreshSettings` | ~0.2 KB | 刷新设置 |
| `recommendWindowId` | ~0.1 KB | 窗口ID |

---

### 书签推荐总计（半年）

| 项目 | 典型大小 | 最大大小 |
|------|:--------:|:--------:|
| S值缓存 | 100 KB | 500 KB |
| 待复习队列 | 4 KB | 10 KB |
| 屏蔽列表 | 1.5 KB | 5 KB |
| 已翻阅记录 | 25 KB | 45 KB |
| 复习数据 | 30 KB | 60 KB |
| 其他 | 3 KB | 5 KB |
| **合计** | **~165 KB** | **~625 KB** |

---

## 二、书签记录 (Active Time Tracking)

### 2.1 会话数据 `IndexedDB: active_sessions`

```javascript
// 每条会话记录约 200-300 bytes
{
    id: 1,
    url: "https://example.com/page",
    bookmarkId: "123",
    title: "页面标题",
    startTime: 1699999999999,
    endTime: 1700000000000,
    totalMs: 60000,
    activeMs: 45000,
    idleFocusMs: 10000,
    visibleMs: 5000,
    backgroundMs: 0,
    compositeMs: 52500,
    wakeCount: 2
}
```

| 每天记录 | 半年累积 | 大小 |
|:--------:|:--------:|------|
| 20 条 | 3,600 条 | ~900 KB |
| 50 条 | 9,000 条 | ~2.25 MB |
| 100 条 | 18,000 条 | ~4.5 MB |

**注意**：同一URL 5分钟内会合并，实际条数更少

---

### 2.2 T值缓存 `trackingRankingCache`（内存）

```javascript
// 内存中，页面关闭后清空
// 按URL聚合的综合时间
{ "url": compositeMs }
```

| URL数 | 内存占用 |
|:-----:|:--------:|
| 100 | ~10 KB |
| 500 | ~50 KB |
| 1000 | ~100 KB |

**半年变化**：仅内存，不持久化

---

### 2.3 其他存储

| 存储项 | 大小 | 说明 |
|--------|------|------|
| `trackingEnabled` | ~10 bytes | 开关状态 |

---

### 书签记录总计（半年）

| 项目 | 典型大小 | 最大大小 |
|------|:--------:|:--------:|
| IndexedDB会话 | 1 MB | 5 MB |
| 内存缓存 | 50 KB | 100 KB |
| **合计** | **~1 MB** | **~5 MB** |

---

## 三、汇总

### 3.1 chrome.storage.local 占用

| 功能 | 典型 | 最大 |
|------|:----:|:----:|
| 书签推荐 | 165 KB | 625 KB |
| 书签记录 | 10 bytes | 10 bytes |
| **合计** | **~165 KB** | **~625 KB** |

### 3.2 IndexedDB 占用

| 功能 | 典型 | 最大 |
|------|:----:|:----:|
| 书签记录会话 | 1 MB | 5 MB |
| Favicon缓存 | 5 MB | 20 MB |
| **合计** | **~6 MB** | **~25 MB** |

### 3.3 内存占用（运行时）

| 功能 | 典型 | 最大 |
|------|:----:|:----:|
| T值缓存 | 50 KB | 100 KB |
| 跳过书签集合 | 1 KB | 10 KB |
| 活跃会话 | 5 KB | 20 KB |
| **合计** | **~56 KB** | **~130 KB** |

---

## 四、存储配额

| 存储类型 | Chrome限制 | 我们使用 | 占比 |
|----------|:----------:|:--------:|:----:|
| storage.local | 10 MB | ~0.6 MB | 6% |
| IndexedDB | 无硬限制* | ~25 MB | - |
| 内存 | 无限制 | ~0.1 MB | - |

*IndexedDB 受磁盘空间限制，通常 >50% 可用空间

---

## 五、优化建议

### 5.1 自动清理策略

| 数据 | 清理策略 | 当前状态 |
|------|---------|:--------:|
| flippedBookmarks | 超过1000条裁剪 | ✅ 已实现 |
| 过期待复习 | 自动移除过期项 | ✅ 已实现 |
| IndexedDB会话 | 保留最近90天 | ⚠️ 建议实现 |
| Favicon缓存 | 配额不足时清理 | ✅ 已实现 |

### 5.2 建议添加的清理

```javascript
// 清理超过90天的会话记录
async function cleanupOldSessions() {
    const cutoff = Date.now() - 90 * 24 * 60 * 60 * 1000;
    // 删除 endTime < cutoff 的记录
}
```

---

## 六、结论

**半年正常使用预估：**
- **storage.local**: ~200 KB（远低于10MB限制）
- **IndexedDB**: ~6 MB（可接受）
- **内存**: ~60 KB（可忽略）

**极限使用预估：**
- **storage.local**: ~625 KB（仍远低于限制）
- **IndexedDB**: ~25 MB（需考虑清理策略）

**风险评估**：低风险，当前设计合理，建议添加IndexedDB会话的90天自动清理。
