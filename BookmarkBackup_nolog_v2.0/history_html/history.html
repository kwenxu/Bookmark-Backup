<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <link rel="stylesheet" href="history.css">
    <link rel="stylesheet" href="canvas_obsidian_style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="bookmark_tree_context_menu.js" defer></script>
    <script src="bookmark_tree_drag_drop.js" defer></script>
    <script src="bookmark_canvas_module.js" defer></script>
    <script src="history.js" defer></script>
</head>
<body>
    <!-- 头部导航 -->
    <header class="history-header">
        <div class="header-left">
            <h1 id="pageTitle">备份历史查看器</h1>
            <span class="header-subtitle" id="pageSubtitle">类似 Git 的书签变化追踪</span>
        </div>
        <div class="header-right">
            <!-- 搜索框 -->
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="搜索书签、文件夹..." />
                <i class="fas fa-search"></i>
            </div>
            
            <!-- 工具按钮组 -->
            <div class="tool-buttons">
                <button id="refreshBtn" class="tool-btn">
                    <i class="fas fa-sync-alt"></i>
                    <span class="btn-tooltip" id="refreshTooltip"></span>
                </button>
                <!-- 主题切换按钮 - 独立设置，主UI优先 -->
                <button id="themeToggle" class="tool-btn">
                    <i class="fas fa-moon"></i>
                    <span class="btn-tooltip" id="themeTooltip"></span>
                </button>
                <!-- 语言切换按钮 - 独立设置，主UI优先 -->
                <button id="langToggle" class="tool-btn">
                    <span class="lang-text">EN</span>
                    <span class="btn-tooltip" id="langTooltip"></span>
                </button>
            </div>
        </div>
    </header>

    <!-- 主内容区域 -->
    <div class="main-container">
        <!-- 左侧导航栏 -->
        <aside class="sidebar" id="sidebar">
            <!-- 侧边栏收起按钮 -->
            <button class="sidebar-toggle" id="sidebarToggle" title="收起/展开侧边栏">
                <i class="fas fa-chevron-left"></i>
            </button>
            
            <nav class="nav-tabs">
                <!-- Bookmark Git 区域组 -->
                <div class="nav-group">
                    <div class="nav-group-title" id="bookmarkGitTitle"></div>
                    <button class="nav-tab" data-view="current-changes">
                        <i class="fas fa-exchange-alt"></i>
                        <span id="navCurrentChangesText">当前 数量/结构 变化</span>
                    </button>
                    <button class="nav-tab" data-view="history">
                        <i class="fas fa-history"></i>
                        <span id="navHistoryText">备份历史</span>
                    </button>
                </div>

                <!-- Bookmark toolbox 区域组 -->
                <div class="nav-group">
                    <div class="nav-group-title" id="bookmarkToolboxTitle"></div>
                    <button class="nav-tab" data-view="canvas">
                        <i class="fas fa-project-diagram"></i>
                        <span id="navCanvasText">Bookmark Canvas</span>
                    </button>
                    <button class="nav-tab" data-view="additions">
                        <i class="fas fa-plus-circle"></i>
                        <span id="navAdditionsText">书签添加记录</span>
                    </button>
                </div>
            </nav>

            <!-- 统计信息 -->
            <div class="stats-panel">
                <h3 id="statsTitle">统计信息</h3>
                <div class="stat-item">
                    <span id="statBackupsLabel">总备份次数</span>
                    <strong id="statBackupsCount">0</strong>
                </div>
                <div class="stat-item">
                    <span id="statBookmarksLabel">当前书签</span>
                    <strong id="statBookmarksCount">0</strong>
                </div>
                <div class="stat-item">
                    <span id="statFoldersLabel">当前文件夹</span>
                    <strong id="statFoldersCount">0</strong>
                </div>
            </div>
        </aside>

        <!-- 右侧内容区域 -->
        <main class="content-area">
            <!-- 当前变化视图 -->
            <div id="current-changesView" class="view">
                <div class="view-header">
                    <h2 id="currentChangesViewTitle">当前 数量/结构 变化</h2>
                    <div class="view-header-right">
                        <button id="revertAllCurrentBtn" class="view-action-btn">
                            <i class="fas fa-undo"></i>
                            <span id="revertAllCurrentText">全部撤销</span>
                        </button>
                    </div>
                </div>
                <div id="currentChangesList" class="current-changes-container">
                    <!-- 动态加载当前变化 -->
                </div>
            </div>

            <!-- 备份历史视图 -->
            <div id="historyView" class="view">
                <div class="view-header">
                    <div class="view-header-left">
                        <h2 id="historyViewTitle">备份历史记录</h2>
                    </div>
                    <div class="view-header-right">
                        <button id="copyAllHistoryBtn" class="view-action-btn" data-action="copyAllHistory">
                            <i class="fas fa-copy"></i>
                            <span id="copyAllHistoryText">复制所有记录</span>
                        </button>
                    </div>
                </div>
                <div id="historyList" class="history-commits">
                    <!-- 动态加载历史记录 -->
                </div>
            </div>

            <!-- 书签添加记录视图 -->
            <div id="additionsView" class="view">
                <div class="view-header">
                    <h2 id="additionsViewTitle">书签添加记录</h2>
                </div>
                
                <!-- 过滤器 -->
                <div class="filter-bar">
                    <div class="filter-group">
                        <label class="filter-label" id="filterStatusLabel">状态</label>
                        <button class="filter-btn active" data-filter="all" id="filterAll">全部</button>
                        <button class="filter-btn" data-filter="backed-up" id="filterBackedUp">已备份</button>
                        <button class="filter-btn" data-filter="not-backed-up" id="filterNotBackedUp">未备份</button>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label" id="filterTimeLabel">时间</label>
                        <button class="time-filter-btn active" data-time-filter="all" id="timeFilterAll">全部</button>
                        <button class="time-filter-btn" data-time-filter="year" id="timeFilterYear">按年</button>
                        <button class="time-filter-btn" data-time-filter="month" id="timeFilterMonth">按月</button>
                        <button class="time-filter-btn" data-time-filter="day" id="timeFilterDay">按日</button>
                    </div>
                </div>

                <div id="additionsList" class="additions-container">
                    <!-- 动态加载书签添加记录 -->
                </div>
            </div>

            <!-- Bookmark Canvas 视图 (原Bookmark Tree改造) -->
            <div id="canvasView" class="view">
                <div class="view-header">
                    <div class="view-header-left">
                        <h2 id="canvasViewTitle">Bookmark Canvas</h2>
                    </div>
                    <div class="view-header-right">
                        <button id="importCanvasBtn" class="view-action-btn">
                            <i class="fas fa-file-import"></i>
                            <span id="importCanvasText">导入</span>
                        </button>
                        <button id="exportCanvasBtn" class="view-action-btn">
                            <i class="fas fa-file-export"></i>
                            <span id="exportCanvasText">导出</span>
                        </button>
                        <button id="clearTempNodesBtn" class="view-action-btn">
                            <i class="fas fa-trash-alt"></i>
                            <span id="clearTempNodesText">清空临时节点</span>
                        </button>
                    </div>
                </div>
                
                <!-- Canvas主容器 -->
                <div class="canvas-main-container" style="--canvas-scale: 1; --canvas-pan-x: 0px; --canvas-pan-y: 0px;">
                    <!-- 自定义纵向滚动条 -->
                    <div class="canvas-scrollbar vertical" id="canvasVerticalScrollbar">
                        <div class="scrollbar-controls">
                            <button class="scrollbar-btn scroll-hide" data-axis="vertical" data-action="toggle-hide" aria-label="隐藏纵向滚动条">
                                <i class="fas fa-eye-slash"></i>
                            </button>
                            <button class="scrollbar-btn scroll-disable" data-axis="vertical" data-action="toggle-disable" aria-label="禁用纵向滚动">
                                <i class="fas fa-ban"></i>
                            </button>
                        </div>
                        <div class="scrollbar-track">
                            <div class="scrollbar-thumb" data-axis="vertical"></div>
                        </div>
                    </div>
                    
                    <!-- 自定义横向滚动条 -->
                    <div class="canvas-scrollbar horizontal" id="canvasHorizontalScrollbar" style="display: flex; align-items: center; gap: 12px;">
                        <div class="scrollbar-controls">
                            <button class="scrollbar-btn scroll-hide" data-axis="horizontal" data-action="toggle-hide" aria-label="隐藏横向滚动条">
                                <i class="fas fa-eye-slash"></i>
                            </button>
                            <button class="scrollbar-btn scroll-disable" data-axis="horizontal" data-action="toggle-disable" aria-label="禁用横向滚动">
                                <i class="fas fa-ban"></i>
                            </button>
                        </div>
                        <span class="scrollbar-hint" data-i18n-text="horizontalScrollHint" data-en="Shift + Wheel" data-zh="Shift + 滚轮">Shift + 滚轮</span>
                        <div class="scrollbar-track">
                            <div class="scrollbar-thumb" data-axis="horizontal"></div>
                        </div>
                    </div>
                    
                    <!-- Canvas画布工作区 -->
                    <div class="canvas-workspace" id="canvasWorkspace">
                        <!-- 缩放控制器（固定在画布左上角） -->
                        <div class="canvas-zoom-indicator" id="canvasZoomIndicator" style="display: none;">
                            <div class="canvas-zoom-header">
                                <button class="canvas-fullscreen-btn" id="canvasFullscreenBtn" aria-label="进入全屏" aria-pressed="false">全屏</button>
                                <span class="canvas-zoom-label" id="canvasZoomLabel">缩放</span>
                                <span class="zoom-value" id="zoomValue">100%</span>
                            </div>
                            <div class="canvas-zoom-controls">
                                <button class="zoom-btn" id="zoomLocateBtn" title="定位到永久栏目"><span id="zoomLocateText">定位</span></button>
                                <button class="zoom-btn" id="zoomOutBtn" title="缩小 (10%)">−</button>
                                <button class="zoom-btn" id="zoomInBtn" title="放大 (10%)">+</button>
                            </div>
                            <div style="font-size: 10px; margin-top: 6px; color: #57606a; text-align: center;" id="canvasZoomHint">
                                <kbd style="font-size: 9px; padding: 2px 4px; background: #f6f8fa; border: 1px solid #d0d7de; border-radius: 3px;">Ctrl</kbd> + 滚轮 | 
                                <kbd style="font-size: 9px; padding: 2px 4px; background: #f6f8fa; border: 1px solid #d0d7de; border-radius: 3px;">空格</kbd> 拖动
                            </div>
                        </div>
                        
                        <!-- Canvas内容容器（应用缩放和平移） -->
                        <div class="canvas-content" id="canvasContent">
                            <!-- 临时节点和永久栏目都在这里 -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 永久栏目 - 在canvas-content内部通过JS添加 -->
            <template id="permanentSectionTemplate">
                <div class="permanent-bookmark-section" id="permanentSection">
                    <div class="permanent-section-header" id="permanentSectionHeader">
                        <div class="permanent-section-title">
                            <h3 id="permanentSectionTitle">书签树 (永久栏目)</h3>
                            <div class="permanent-section-actions">
                                <button class="permanent-section-action-btn permanent-section-pin-btn pinned" id="permanentSectionPinBtn" title="置顶栏目">
                                    <i class="fas fa-thumbtack"></i>
                                </button>
                            </div>
                        </div>
                        <div class="permanent-section-tip-container" id="permanentSectionTipContainer">
                            <p class="permanent-section-tip" id="permanentSectionTip">拖动书签/文件夹至空白处，创建书签型临时节点；临时节点的修改不计入核心数据，可用来对比查看/整理；栏目间可互相拖动/粘贴</p>
                            <button class="permanent-section-tip-close" id="permanentSectionTipClose" title="关闭提示">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="permanent-section-body">
                        <div id="bookmarkTree" class="bookmark-tree">
                            <!-- 动态加载书签树 -->
                        </div>
                    </div>
                </div>
            </template>
        </main>
    </div>

    <!-- 撤销覆盖层 -->
    <div id="revertOverlay" class="revert-overlay" style="display: none;">
        <div class="revert-overlay-content">
            <div class="revert-spinner"></div>
            <div class="revert-text" id="revertOverlayText">正在处理中...</div>
        </div>
    </div>

    <!-- 详情弹窗 -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">变化详情</h3>
                <button class="modal-close" id="modalClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- 动态加载详情内容 -->
            </div>
        </div>
    </div>
</body>
</html>
