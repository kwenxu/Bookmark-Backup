/* Minimal local Markdown parser to satisfy CSP. Not full-featured 'marked'. */
(function (global) {
  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function parse(md) {
    if (!md) return '';

    // Code blocks ```...```
    let text = md.replace(/```([\s\S]*?)```/g, function (_, code) {
      return '<pre><code>' + escapeHtml(code) + '</code></pre>';
    });

    const lines = text.split(/\r?\n/);
    const out = [];
    let inList = false;

    const flushList = () => {
      if (inList) {
        out.push('</ul>');
        inList = false;
      }
    };

    const inline = (s) => {
      // escape first
      let t = escapeHtml(s);
      // links [text](http...)
      t = t.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
      // inline code `code`
      t = t.replace(/`([^`]+)`/g, '<code>$1</code>');
      // bold **text**
      t = t.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      return t;
    };

    for (let line of lines) {
      if (/^###\s+/.test(line)) {
        flushList();
        out.push('<h3>' + inline(line.replace(/^###\s+/, '')) + '</h3>');
        continue;
      }
      if (/^##\s+/.test(line)) {
        flushList();
        out.push('<h2>' + inline(line.replace(/^##\s+/, '')) + '</h2>');
        continue;
      }
      if (/^#\s+/.test(line)) {
        flushList();
        out.push('<h1>' + inline(line.replace(/^#\s+/, '')) + '</h1>');
        continue;
      }
      if (/^\s*[-*]\s+/.test(line)) {
        if (!inList) {
          inList = true;
          out.push('<ul>');
        }
        const itemText = line.replace(/^\s*[-*]\s+/, '');
        out.push('<li>' + inline(itemText) + '</li>');
        continue;
      } else if (inList) {
        flushList();
      }

      if (line.trim() === '') {
        out.push('');
        continue;
      }
      out.push('<p>' + inline(line) + '</p>');
    }
    flushList();
    return out.join('\n').replace(/\n{2,}/g, '\n');
  }

  global.marked = { parse: parse };
})(typeof window !== 'undefined' ? window : this);
